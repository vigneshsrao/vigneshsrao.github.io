<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.1"><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="InCTF ateles Write-up" /><meta name="author" content="Vignesh S Rao" /><meta property="og:locale" content="en_US" /><meta name="description" content="2 element overflow in Array when jit compiled" /><meta property="og:description" content="2 element overflow in Array when jit compiled" /><link rel="canonical" href="https://vigneshsrao.github.io/posts/ateles/" /><meta property="og:url" content="https://vigneshsrao.github.io/posts/ateles/" /><meta property="og:site_name" content="sherl0ck’s home" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-10-04T00:00:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="InCTF ateles Write-up" /><meta name="twitter:site" content="@sherl0ck__" /><meta name="twitter:creator" content="@Vignesh S Rao" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"2 element overflow in Array when jit compiled","url":"https://vigneshsrao.github.io/posts/ateles/","headline":"InCTF ateles Write-up","dateModified":"2020-12-31T20:26:34+05:30","@type":"BlogPosting","datePublished":"2019-10-04T00:00:00+05:30","mainEntityOfPage":{"@type":"WebPage","@id":"https://vigneshsrao.github.io/posts/ateles/"},"author":{"@type":"Person","name":"Vignesh S Rao"},"@context":"https://schema.org"}</script><title>InCTF ateles Write-up | sherl0ck's home</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">sherl0ck's home</a></div><div class="site-subtitle font-italic">What is this life if, full of care, We have no time to stand and stare.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/resume/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>RESUME</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/vigneshsrao" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/sherl0ck__" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['vigneshsrao5','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>InCTF ateles Write-up</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>InCTF ateles Write-up</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Oct 4, 2019, 12:00 AM +0530" > Oct 4, 2019 <i class="unloaded">2019-10-04T00:00:00+05:30</i> </span> by <span class="author"> Vignesh S Rao </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Dec 31, 2020, 8:26 PM +0530" > Dec 31, 2020 <i class="unloaded">2020-12-31T20:26:34+05:30</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1482 words">8 min</span></div></div><div class="post-content"><p>About a couple of weeks ago, teambi0s conducted InCTF, an International level CTF and I had the opportunity to create a couple of challenges - <code class="language-plaintext highlighter-rouge">ateles</code> and <code class="language-plaintext highlighter-rouge">navarint</code>. <code class="language-plaintext highlighter-rouge">ateles </code>. Now let’s delve into <code class="language-plaintext highlighter-rouge">ateles</code>!</p><h2 id="attachments">Attachments</h2><p>There were 2 files provided - <code class="language-plaintext highlighter-rouge">ateles_handout.zip</code> and <code class="language-plaintext highlighter-rouge">ateles_handout_large.zip</code>.</p><p>The <code class="language-plaintext highlighter-rouge">ateles_handout_large</code> contains a non-debug js shell built with the provided patch, and also the environment the challenge is running on, in the remote server.</p><p>On the remote server sandbox was disabled. Also, <code class="language-plaintext highlighter-rouge">javascript.options.ion.offthread_compilation</code> is set to false, to increase the realibility of exploits. These settings can be tweaked in the <code class="language-plaintext highlighter-rouge">docker_stuff/firefox/vulnProfile/prefs.js</code> file. The built firefox browser runs with the <code class="language-plaintext highlighter-rouge">vulnProfile</code> profile. (<code class="language-plaintext highlighter-rouge">docker_stuff/firefox/vulnProfile </code>)</p><p>The <code class="language-plaintext highlighter-rouge">ateles_handout.zip</code> contains the patch file that is to be applied.</p><h2 id="vulnerability">Vulnerability</h2><h3 id="analyzing-the-patch">Analyzing the patch</h3><p>The patch file is pretty short</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="n">diff</span> <span class="o">-</span><span class="n">r</span> <span class="mi">3</span><span class="n">d02a4c69a81</span> <span class="n">js</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">CodeGenerator</span><span class="p">.</span><span class="n">cpp</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">js</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">CodeGenerator</span><span class="p">.</span><span class="n">cpp</span>      <span class="n">Thu</span> <span class="n">Sep</span> <span class="mi">19</span> <span class="mo">06</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mi">14</span> <span class="mi">2019</span> <span class="o">+</span><span class="mo">0300</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">js</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">CodeGenerator</span><span class="p">.</span><span class="n">cpp</span>      <span class="n">Fri</span> <span class="n">Sep</span> <span class="mi">20</span> <span class="mi">15</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mo">07</span> <span class="mi">2019</span> <span class="o">+</span><span class="mo">0530</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">9177</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">9177</span><span class="p">,</span><span class="mi">9</span> <span class="err">@@</span>
 <span class="kt">void</span> <span class="n">CodeGenerator</span><span class="o">::</span><span class="n">visitInitializedLength</span><span class="p">(</span><span class="n">LInitializedLength</span><span class="o">*</span> <span class="n">lir</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">Address</span> <span class="n">initLength</span><span class="p">(</span><span class="n">ToRegister</span><span class="p">(</span><span class="n">lir</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">()),</span>
                      <span class="n">ObjectElements</span><span class="o">::</span><span class="n">offsetOfInitializedLength</span><span class="p">());</span>
<span class="o">-</span>  <span class="n">masm</span><span class="p">.</span><span class="n">load32</span><span class="p">(</span><span class="n">initLength</span><span class="p">,</span> <span class="n">ToRegister</span><span class="p">(</span><span class="n">lir</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">()));</span>
<span class="o">+</span>  <span class="n">Register</span> <span class="n">out</span> <span class="o">=</span> <span class="n">ToRegister</span><span class="p">(</span><span class="n">lir</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">());</span>
<span class="o">+</span>  <span class="n">masm</span><span class="p">.</span><span class="n">load32</span><span class="p">(</span><span class="n">initLength</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
<span class="o">+</span>  <span class="n">masm</span><span class="p">.</span><span class="n">addq</span><span class="p">(</span><span class="n">Imm32</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">out</span><span class="p">);</span>
 <span class="p">}</span>

 <span class="kt">void</span> <span class="n">CodeGenerator</span><span class="o">::</span><span class="n">visitSetInitializedLength</span><span class="p">(</span><span class="n">LSetInitializedLength</span><span class="o">*</span> <span class="n">lir</span><span class="p">)</span> <span class="p">{</span>
</pre></table></code></div></div><p>The function’s in <code class="language-plaintext highlighter-rouge">CodeGenerator.cpp</code> are called when Ion tries to JIT compile code and wants to look up how a specific piece/segment of code is to be compiled.</p><p>In this case the patched code is a part of the function <code class="language-plaintext highlighter-rouge">visitInitializedLength</code>. This is called when trying to JIT compile a segment of code that accesses the initialized length of an Array. For example while compiling the following code snippet :</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nx">arr</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
</pre></table></code></div></div><p>While trying to compile this code, first the index (idx) is checked against the initialized length to verify that it is smaller than it. The code for this is emitted by the function <code class="language-plaintext highlighter-rouge">visitInitializedLength</code>. As we can see, initially all it did was to load the initialised length into a register. In the patch the initialized length is loaded into the register and then <code class="language-plaintext highlighter-rouge">2</code> is added to the register. Thus, now when the JIT’ed code is executed, the index will be checked against the initialized length plus 2, thus giving us access to 2 more elements than what the <code class="language-plaintext highlighter-rouge">initializedLength</code> field of the Array specifies.</p><h3 id="poc">PoC</h3><p>Ok, that was straightforward, but how can we trigger a crash with this? Well, the easiest (and only one I could think of :)) way I found was to use this 2 element overflow to overwrite the <code class="language-plaintext highlighter-rouge">group</code> and <code class="language-plaintext highlighter-rouge">shape</code> field of the <code class="language-plaintext highlighter-rouge">JSObject</code> that follows the vulnerable <code class="language-plaintext highlighter-rouge">Array</code>. Here is a crashing sample</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nx">blah</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">()</span>
<span class="nx">blah</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span><span class="mf">1.1</span><span class="p">))</span>
<span class="nx">blah</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">Uint32Array</span><span class="p">(</span><span class="mh">0x10</span><span class="p">))</span>

<span class="kd">function</span> <span class="nx">trigger</span><span class="p">(</span><span class="nx">a1</span><span class="p">,</span><span class="nx">a2</span><span class="p">){</span>
  <span class="nx">blah</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nx">a1</span><span class="p">]</span><span class="o">=</span><span class="mf">1.337</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="mi">100000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){}</span>
<span class="p">}</span>

<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">trigger</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nx">trigger</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nx">blah</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></table></code></div></div><p>Here we first create a Array that holds 2 objects, namely another Array and also a <code class="language-plaintext highlighter-rouge">Uint32Array</code>. These are allocated one after other in the nursery heap (firefox’s primary heap for short lived objects).</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>
gef➤ x/10xg 0x28a7da500550  &lt;<span class="nt">--</span> <span class="sb">`</span>blah<span class="sb">`</span> Array

0x28a7da500550: 0x00002d73b8b7e820      0x00002d73b8b8fba0
0x28a7da500560: 0x0000000000000000      0x000028a7da500580
0x28a7da500570: 0x0000000200000000      0x0000000200000006
0x28a7da500580: 0xfffe28a7da5005d8 &lt;-+  0xfffe28a7da500618 &lt;<span class="nt">------</span>+
0x28a7da500590: 0x2f2f2f2f2f2f2f2f   |  0x2f2f2f2f2f2f2f2f        |
                                     |                            |
               blah[0] <span class="o">(</span>new Array<span class="o">)</span>   |  blah[1] <span class="o">(</span>new Uint32Array<span class="o">)</span> |
                          +----------+                            |
gef➤ x/8xg 0x28a7da5005d8 |                                       |
0x28a7da5005d8: 0x00002d73b8b7e850      0x00002d73b8b8fba0        |
0x28a7da5005e8: 0x0000000000000000      0x000028a7da500608        |
0x28a7da5005f8: 0x0000000200000000      0x0000000200000002        |
0x28a7da500608: 0x3ff199999999999a      0x3ff199999999999a        |
gef➤     +--------------------------------------------------------+
         |
0x28a7da500618: 0x00002d73b8b7e9d0      0x00002d73b8ba5330 |
0x28a7da500628: 0x0000000000000000      0x0000564e7c87ff98
0x28a7da500638: 0xfffa000000000000      0xfff8800000000010
0x28a7da500648: 0xfff8800000000000      0x000028a7da500658
</pre></table></code></div></div><p>As is obvious, both the elements lie just one after another. Thus we can use the 2 element overflow in the <code class="language-plaintext highlighter-rouge">blah[0]</code> array to change the group and the shape of the following object, which is the <code class="language-plaintext highlighter-rouge">Uint32Array</code>. In this crashing sample, we overwrite the <code class="language-plaintext highlighter-rouge">group</code> pointer of the <code class="language-plaintext highlighter-rouge">Uint32Array</code> with a float value 1.337 which leads to it becoming an invalid pointer and thus crashing when we try to access this object (When we try to access an object the group and the shape pointers are read which leads to spidermonkey trying to de-reference an invalid pointer)</p><h2 id="exploitation">Exploitation</h2><p>Right so now that we are clear with what the bug is, we can go ahead and try to achieve arbitrary read-write. With this overflow, we can change the group and shape pointer of any object to that of any other object. So basically we can hijack the identity of an object to make spidermonkey think that it’s of a different type, which gives us the power to create arbitrary type-confusions in the memory.</p><p>So now the question is which object should we confuse with which other object to make our job of exploitation easier? After pondering over it for some time I used kind of the same technique that I used while trying to <a href="https://vigneshsrao.github.io/writeup/">exploit CVE-2019-11707</a>. Here I initially create a <code class="language-plaintext highlighter-rouge">Uint8Array</code> and overwrite the <code class="language-plaintext highlighter-rouge">group</code> and <code class="language-plaintext highlighter-rouge">shape</code> to that of a <code class="language-plaintext highlighter-rouge">Uint32Array</code>. Now let’s assume that the size of the <code class="language-plaintext highlighter-rouge">Uint8Array</code> is 16. That means that the size of the buffer will be <code class="language-plaintext highlighter-rouge">16*1=4</code>. Now we overwritet the group and shape to that of <code class="language-plaintext highlighter-rouge">Uint32Array</code>. But here each element is of 4 bytes size. Thus the size of the buffer becomes <code class="language-plaintext highlighter-rouge">16*4=64</code>, giving us a sufficiently large overflow. Thus we converted our 2 element overflow to a larger, more controlled overflow in a typed array!</p><p>From here the exploitation can proceed in pretty much the same way as the one in my previous post on <a href="https://vigneshsrao.github.io/writeup/#confusing-uint8array-and-uint32array">CVE-2019-11707</a>. We create an array of array buffer’s and set the underlying buffer of the <code class="language-plaintext highlighter-rouge">Uint8Array</code> (which we will corrupt) to any one of those array buffers. Then with this overflow, we can change the size field of the following array buffer to a larger one which will lead to us getting arbitrary read-write.</p><p>After this, the exploitation method is ditto same as the previous post. Please refer the above mentioned post for more details. Let me give a gist of the exploit here -</p><ul><li>Let’s say that we have some consecutive array buffers in the memory - A-B-C-D<li>We use the overflow in ‘A’ to overwrite the length field of ‘B’ array buffer and make it to a large size.<li>We use this to leak the address contained in the metadata of ‘C’.<li>The leaks contain - The address of an TypedArray created on this array buffer and the address of this array buffer.<li>Now we again use the overflow in ‘B’ to overwrite the address of the DataBuffer of ‘C’ to the address of the data buffer of a <code class="language-plaintext highlighter-rouge">Uint8Arry</code> (say <code class="language-plaintext highlighter-rouge">leaker</code>)<li>Now we create a <code class="language-plaintext highlighter-rouge">Uint8Array</code> view on the <code class="language-plaintext highlighter-rouge">C</code> ArrayBuffer. Thus it’s buffer is actually the address of the data buffer of the <code class="language-plaintext highlighter-rouge">leaker</code> array.<li>Thus we control the DataBuffer of the leaker array and can point it to any address to achieve arbitrary read-write.</ul><p>Now for getting code execution (This is also the same as the previous post but here’s a gist anyway) -</p><ul><li>Our aim will be to overwrite the the <code class="language-plaintext highlighter-rouge">addProperty</code> function pointer in the <code class="language-plaintext highlighter-rouge">ClassOops</code> structure.<li>We will overwrite it with a stager shellcode that will mprotect a second region with rwx permission. This second region will be where we have our actual shellcode.<li>The stager shellcode will be JIT compiled. Thus we place it in a function and call it over and over to jit compile it.<li>We leak the address of this using our arbitrary read primitive.<li>We also write a shellcode for execve(‘/usr/bin/xcalc’,0,0) and also leak it’s address.<li>We then overwrite the <code class="language-plaintext highlighter-rouge">addProperty</code> function pointer with the address of the shellcode.<li>To trigger the chain, we add a property with the value of the property as the address of our actual shellcode buffer.<li>When this happens, the address of the shellcode buffer goes into the <code class="language-plaintext highlighter-rouge">rcx</code> register and our stager shellcode is called.<li>The stager shellcode mprotects the page pointed to by <code class="language-plaintext highlighter-rouge">rcx</code> to make it rwx and then jumps to that region.<li>In the now rwx region, we execute the shellcode for execve(‘/usr/bin/xcalc’,NULL,NULL);</ul><p>I just copy pasted the code for this whole part directly from my previous exploit. There was only a small change - The previous exploit was written for firefox 66 and the one given in the challenge was the latest version, pulled just a couple of day’s prior to the CTF. Thus there was a slight change in the structure of <code class="language-plaintext highlighter-rouge">ArrayBuffer</code>. Earlier the right shifted value of the data pointer of the ArrayBuffer was in the memory. Now, the data pointer is stored as it is. So only a slight modification is required in the previous exploit.</p><p>The full exploit can be found on <a href="https://github.com/vigneshsrao/InCTF/tree/master/pwn2019/ateles/exploit">github</a></p><p>After finishing the exploit, we have to host the whole thing (wrapped in a html file) on a server, and send the link to the remote service.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/ateles/ateles.png" alt="flag.png" /></p><p>And the flag was</p><blockquote><p>inctf{r3sh4ping_th3_ateles_for_sh4ping_up_a_pr0t3le$}</p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf-writeup/'>CTF_writeup</a>, <a href='/categories/browser-exploitation/'>Browser Exploitation</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/writeup/" class="post-tag no-text-decoration" >writeup</a> <a href="/tags/spidermonkey/" class="post-tag no-text-decoration" >spidermonkey</a> <a href="/tags/jit/" class="post-tag no-text-decoration" >jit</a> <a href="/tags/inctf/" class="post-tag no-text-decoration" >InCTF</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=InCTF ateles Write-up - sherl0ck's home&url=https://vigneshsrao.github.io/posts/ateles/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=InCTF ateles Write-up - sherl0ck's home&u=https://vigneshsrao.github.io/posts/ateles/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=InCTF ateles Write-up - sherl0ck's home&url=https://vigneshsrao.github.io/posts/ateles/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/memoheap/">AceBear CTF: memo_heap Writeup</a><li><a href="/posts/findfile/">FindFile</a><li><a href="/posts/fastbin-dup/">Fastbin dup with House of Orange</a><li><a href="/posts/feedback/">InCTF: feedback Writeup</a><li><a href="/posts/lost/">InCTF: lost Writeup</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/spidermonkey/">spidermonkey</a> <a class="post-tag" href="/tags/fastbin/">fastbin</a> <a class="post-tag" href="/tags/experience/">Experience</a> <a class="post-tag" href="/tags/filestructure/">filestructure</a> <a class="post-tag" href="/tags/jit/">jit</a> <a class="post-tag" href="/tags/non-tech/">Non-tech</a> <a class="post-tag" href="/tags/browser/">browser</a> <a class="post-tag" href="/tags/forensics/">Forensics</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/writeup/"><div class="card-body"> <span class="timeago small" > Aug 15, 2019 <i class="unloaded">2019-08-15T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Write up for CVE-2019-11707</h3><div class="text-muted small"><p> I was always very curious about vulnerabilities that kept popping up in the JIT compilers of various popular browsers. A couple of months I came across CVE-2019-11707, which was a type-confusion bu...</p></div></div></a></div><div class="card"> <a href="/posts/memoheap/"><div class="card-body"> <span class="timeago small" > Feb 1, 2018 <i class="unloaded">2018-02-01T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AceBear CTF: memo_heap Writeup</h3><div class="text-muted small"><p> I didn’t get a chance to try this challenge out during the CTF, but it was a pretty interesting and fun challenge. The method I am going to describe may not be the most efficient but this is what c...</p></div></div></a></div><div class="card"> <a href="/posts/feedback/"><div class="card-body"> <span class="timeago small" > Oct 12, 2018 <i class="unloaded">2018-10-12T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>InCTF: feedback Writeup</h3><div class="text-muted small"><p> Attachments: binary libc source The binary is a non-stripped ELF 64 bit file. It is basically a kind of feedback accepting mechanism. Lets start with the permissions if the binary. gd...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/writeup/" class="btn btn-outline-primary"><p>Write up for CVE-2019-11707</p></a> <span class="btn btn-outline-primary disabled"><p>-</p></span></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/sherl0ck__">Vignesh Rao</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/spidermonkey/">spidermonkey</a> <a class="post-tag" href="/tags/fastbin/">fastbin</a> <a class="post-tag" href="/tags/experience/">Experience</a> <a class="post-tag" href="/tags/filestructure/">filestructure</a> <a class="post-tag" href="/tags/jit/">jit</a> <a class="post-tag" href="/tags/non-tech/">Non tech</a> <a class="post-tag" href="/tags/browser/">browser</a> <a class="post-tag" href="/tags/forensics/">Forensics</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://vigneshsrao.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
