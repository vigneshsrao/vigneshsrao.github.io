I"‹„<p>After getting a bit of hang over the standard C pwnables in CTFs, I was eager to see how this would work in the real world. So I tried starting of with browser pwn. I actually looked at CTFs challenges and though they are not exactly real world I guess they are the closest to it other than actually digging at old CVEs.</p>

<p>Anyway, for the past few days I was trying <code class="language-plaintext highlighter-rouge">blazefox</code> from blazeCTF 2018. In this post though, I‚Äôll be writing about some SpiderMonkey data structures that were required to be understood. In this post I‚Äôll only be focusing on <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey">SpiderMonkey</a> (Mozilla‚Äôs JavaScript engine)</p>

<p>Before starting, I want to say that much of the content is from the <a href="#references">references</a> and this post is more or less about my fiddling with what was mentioned there :P</p>

<h2 id="building-spidermonkey">Building SpiderMonkey</h2>

<p>To experiment with SpiderMonkey, you might want to build a js shell first. A JS shell is basically a js interpreter. The build instructions can be found <a href="https://wiki.mozilla.org/JavaScript:New_to_SpiderMonkey#Get_the_code">here</a>. I am including it below for reference -</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>
hg clone http://hg.mozilla.org/mozilla-central spidermonkey

<span class="nb">cp </span>configure.in configure <span class="o">&amp;&amp;</span> autoconf2.13
<span class="nb">mkdir </span>build_DBG.OBJ
<span class="nb">cd </span>build_DBG.OBJ
../configure <span class="nt">--disable-debug</span> <span class="nt">--disable-optimize</span> <span class="c">#</span>
make <span class="c">## or make -j8</span>
<span class="nb">cd </span>dist/bin/
./js
</pre></td></tr></tbody></table></code></pre></div></div>

<p>PS: I first came accross this on this <a href="https://bruce30262.github.io/Learning-browser-exploitation-via-33C3-CTF-feuerfuchs-challenge/">cool post</a> by <a href="https://twitter.com/bruce30262">brucechen</a></p>

<p><strong>Note:</strong> I am disabling the debug option as this will add many assertions that will break our exploit, once we get to that part but if you are building to just play around then you should probably enable it.</p>

<h2 id="representing-values">Representing Values</h2>

<p>Most of this section is based on <a href="http://www.phrack.org/issues/69/14.html">this phrack article</a>. The author explains everything pretty clearly and it is definitely worth a read.</p>

<h3 id="jsvalue">JSValue</h3>

<p>In JavaScript we can assign values to variables without actually defining their ‚Äútype‚Äù. So we can do <code class="language-plaintext highlighter-rouge">a="this is a string"</code> or <code class="language-plaintext highlighter-rouge">a=1234</code> without specifying <code class="language-plaintext highlighter-rouge">int a</code>, <code class="language-plaintext highlighter-rouge">char a</code> etc like in C. So how does JS kepp track of the datatype of a variable?</p>

<p>Well, all ‚Äútypes‚Äù of data are represented as objects of <code class="language-plaintext highlighter-rouge">JS::Value</code>. <code class="language-plaintext highlighter-rouge">JS::Value</code> or <code class="language-plaintext highlighter-rouge">jsval</code> represents various types in by encoding the ‚Äútype‚Äù as well as the ‚Äúvalue‚Äù in one unit.</p>

<p>In a jsval the top 17 bits are for the tag that represent what is type of the jsval. The lower 47 bits are for the actual value.</p>

<p>Let‚Äôs see this with an example. Run the js shell and create an create an array to hold values of different types -</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nx">js</span><span class="o">&gt;</span>  <span class="nx">a</span><span class="o">=</span><span class="p">[</span><span class="mh">0x11223344</span><span class="p">,</span> <span class="dl">"</span><span class="s2">STRING</span><span class="dl">"</span><span class="p">,</span> <span class="mh">0x44332211</span><span class="p">,</span> <span class="kc">true</span><span class="p">]</span>
<span class="p">[</span><span class="mi">287454020</span><span class="p">,</span> <span class="dl">"</span><span class="s2">STRING</span><span class="dl">"</span><span class="p">,</span> <span class="mi">1144201745</span><span class="p">,</span> <span class="kc">true</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>So our array is like - [int, string, int, Boolean]. Now lets attach gdb to this and see how these look in the memory‚Ä¶</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="n">gdb</span> <span class="o">-</span><span class="n">p</span> <span class="err">$</span><span class="p">(</span><span class="n">pidof</span> <span class="n">js</span><span class="p">)</span>

<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">find</span> <span class="mh">0x11223344</span> <span class="c1"># Searching for the array - all elements will lie consecutively
</span><span class="n">Searching</span> <span class="k">for</span> <span class="s">'0x11223344'</span> <span class="ow">in</span><span class="p">:</span> <span class="bp">None</span> <span class="n">ranges</span>
<span class="n">Found</span> <span class="mi">1</span> <span class="n">results</span><span class="p">,</span> <span class="n">display</span> <span class="nb">max</span> <span class="mi">1</span> <span class="n">items</span><span class="p">:</span>
<span class="n">mapped</span> <span class="p">:</span> <span class="mh">0x7f8e531980d0</span> <span class="o">--&gt;</span> <span class="mh">0xfff8800011223344</span>

<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">xg</span> <span class="mh">0x7f8e531980d0</span>
<span class="mh">0x7f8e531980d0</span><span class="p">:</span>	<span class="mh">0xfff8800011223344</span>	<span class="mh">0xfffb7f8e531ae6a0</span>
<span class="mh">0x7f8e531980e0</span><span class="p">:</span>	<span class="mh">0xfff8800044332211</span>	<span class="mh">0xfff9000000000001</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>So the int <code class="language-plaintext highlighter-rouge">0x11223344</code> is stored as <code class="language-plaintext highlighter-rouge">0xfff8800011223344</code>. Here is the relevant code from <code class="language-plaintext highlighter-rouge">js/public/Value.h</code></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre>
<span class="k">enum</span> <span class="n">JSValueType</span> <span class="o">:</span> <span class="kt">uint8_t</span>
<span class="p">{</span>
    <span class="n">JSVAL_TYPE_DOUBLE</span>              <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
    <span class="n">JSVAL_TYPE_INT32</span>               <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
    <span class="n">JSVAL_TYPE_BOOLEAN</span>             <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
    <span class="n">JSVAL_TYPE_UNDEFINED</span>           <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
    <span class="n">JSVAL_TYPE_NULL</span>                <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
    <span class="n">JSVAL_TYPE_MAGIC</span>               <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
    <span class="n">JSVAL_TYPE_STRING</span>              <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
    <span class="n">JSVAL_TYPE_SYMBOL</span>              <span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>
    <span class="n">JSVAL_TYPE_PRIVATE_GCTHING</span>     <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
    <span class="n">JSVAL_TYPE_OBJECT</span>              <span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>

    <span class="cm">/* These never appear in a jsval; they are only provided as an out-of-band value. */</span>
    <span class="n">JSVAL_TYPE_UNKNOWN</span>             <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
    <span class="n">JSVAL_TYPE_MISSING</span>             <span class="o">=</span> <span class="mh">0x21</span>
<span class="p">};</span>

<span class="o">----</span>

<span class="n">JS_ENUM_HEADER</span><span class="p">(</span><span class="n">JSValueTag</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">JSVAL_TAG_MAX_DOUBLE</span>           <span class="o">=</span> <span class="mh">0x1FFF0</span><span class="p">,</span>
    <span class="n">JSVAL_TAG_INT32</span>                <span class="o">=</span> <span class="n">JSVAL_TAG_MAX_DOUBLE</span> <span class="o">|</span> <span class="n">JSVAL_TYPE_INT32</span><span class="p">,</span>
    <span class="n">JSVAL_TAG_UNDEFINED</span>            <span class="o">=</span> <span class="n">JSVAL_TAG_MAX_DOUBLE</span> <span class="o">|</span> <span class="n">JSVAL_TYPE_UNDEFINED</span><span class="p">,</span>
    <span class="n">JSVAL_TAG_NULL</span>                 <span class="o">=</span> <span class="n">JSVAL_TAG_MAX_DOUBLE</span> <span class="o">|</span> <span class="n">JSVAL_TYPE_NULL</span><span class="p">,</span>
    <span class="n">JSVAL_TAG_BOOLEAN</span>              <span class="o">=</span> <span class="n">JSVAL_TAG_MAX_DOUBLE</span> <span class="o">|</span> <span class="n">JSVAL_TYPE_BOOLEAN</span><span class="p">,</span>
    <span class="n">JSVAL_TAG_MAGIC</span>                <span class="o">=</span> <span class="n">JSVAL_TAG_MAX_DOUBLE</span> <span class="o">|</span> <span class="n">JSVAL_TYPE_MAGIC</span><span class="p">,</span>
    <span class="n">JSVAL_TAG_STRING</span>               <span class="o">=</span> <span class="n">JSVAL_TAG_MAX_DOUBLE</span> <span class="o">|</span> <span class="n">JSVAL_TYPE_STRING</span><span class="p">,</span>
    <span class="n">JSVAL_TAG_SYMBOL</span>               <span class="o">=</span> <span class="n">JSVAL_TAG_MAX_DOUBLE</span> <span class="o">|</span> <span class="n">JSVAL_TYPE_SYMBOL</span><span class="p">,</span>
    <span class="n">JSVAL_TAG_PRIVATE_GCTHING</span>      <span class="o">=</span> <span class="n">JSVAL_TAG_MAX_DOUBLE</span> <span class="o">|</span> <span class="n">JSVAL_TYPE_PRIVATE_GCTHING</span><span class="p">,</span>
    <span class="n">JSVAL_TAG_OBJECT</span>               <span class="o">=</span> <span class="n">JSVAL_TAG_MAX_DOUBLE</span> <span class="o">|</span> <span class="n">JSVAL_TYPE_OBJECT</span>
<span class="p">}</span> <span class="n">JS_ENUM_FOOTER</span><span class="p">(</span><span class="n">JSValueTag</span><span class="p">);</span>

<span class="o">----</span>

<span class="k">enum</span> <span class="n">JSValueShiftedTag</span> <span class="o">:</span> <span class="kt">uint64_t</span>
<span class="p">{</span>
    <span class="n">JSVAL_SHIFTED_TAG_MAX_DOUBLE</span>      <span class="o">=</span> <span class="p">((((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">JSVAL_TAG_MAX_DOUBLE</span><span class="p">)</span>     <span class="o">&lt;&lt;</span> <span class="n">JSVAL_TAG_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xFFFFFFFF</span><span class="p">),</span>
    <span class="n">JSVAL_SHIFTED_TAG_INT32</span>           <span class="o">=</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">JSVAL_TAG_INT32</span><span class="p">)</span>           <span class="o">&lt;&lt;</span> <span class="n">JSVAL_TAG_SHIFT</span><span class="p">),</span>
    <span class="n">JSVAL_SHIFTED_TAG_UNDEFINED</span>       <span class="o">=</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">JSVAL_TAG_UNDEFINED</span><span class="p">)</span>       <span class="o">&lt;&lt;</span> <span class="n">JSVAL_TAG_SHIFT</span><span class="p">),</span>
    <span class="n">JSVAL_SHIFTED_TAG_NULL</span>            <span class="o">=</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">JSVAL_TAG_NULL</span><span class="p">)</span>            <span class="o">&lt;&lt;</span> <span class="n">JSVAL_TAG_SHIFT</span><span class="p">),</span>
    <span class="n">JSVAL_SHIFTED_TAG_BOOLEAN</span>         <span class="o">=</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">JSVAL_TAG_BOOLEAN</span><span class="p">)</span>         <span class="o">&lt;&lt;</span> <span class="n">JSVAL_TAG_SHIFT</span><span class="p">),</span>
    <span class="n">JSVAL_SHIFTED_TAG_MAGIC</span>           <span class="o">=</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">JSVAL_TAG_MAGIC</span><span class="p">)</span>           <span class="o">&lt;&lt;</span> <span class="n">JSVAL_TAG_SHIFT</span><span class="p">),</span>
    <span class="n">JSVAL_SHIFTED_TAG_STRING</span>          <span class="o">=</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">JSVAL_TAG_STRING</span><span class="p">)</span>          <span class="o">&lt;&lt;</span> <span class="n">JSVAL_TAG_SHIFT</span><span class="p">),</span>
    <span class="n">JSVAL_SHIFTED_TAG_SYMBOL</span>          <span class="o">=</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">JSVAL_TAG_SYMBOL</span><span class="p">)</span>          <span class="o">&lt;&lt;</span> <span class="n">JSVAL_TAG_SHIFT</span><span class="p">),</span>
    <span class="n">JSVAL_SHIFTED_TAG_PRIVATE_GCTHING</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">JSVAL_TAG_PRIVATE_GCTHING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">JSVAL_TAG_SHIFT</span><span class="p">),</span>
    <span class="n">JSVAL_SHIFTED_TAG_OBJECT</span>          <span class="o">=</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">JSVAL_TAG_OBJECT</span><span class="p">)</span>          <span class="o">&lt;&lt;</span> <span class="n">JSVAL_TAG_SHIFT</span><span class="p">)</span>
<span class="p">};</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>The code is pretty easy to understand</p>
<ul>
  <li>Each type (Int, String, Boolean etc) is represented by a number as shown in the enum <code class="language-plaintext highlighter-rouge">JSValueType</code></li>
  <li>This is bitwise or‚Äôed with <code class="language-plaintext highlighter-rouge">JSVAL_TAG_MAX_DOUBLE</code> as shown in the enum <code class="language-plaintext highlighter-rouge">JSValueTag</code>. This or‚Äôed value is actually the ‚Äútag‚Äù that will be used in the final representation.</li>
  <li>The 17 bit tag is made to 64 bits by right shifting it by 47 bits.</li>
</ul>

<p>So the tag for int would be</p>

<blockquote>
  <p>(1 | 0x1FFF0) ¬´¬†47 = 0xfff8800000000000</p>
</blockquote>

<p>The value of the actual int is or‚Äôed with this tag and stored as ‚Äò0xfff8800011223344‚Äô in the memory.</p>

<h3 id="jsobject">JSObject</h3>

<p>Ok, so that was about representing values. But JavaScript also has various types of ‚Äúobjects‚Äù, like arrays. Objects tend to have ‚Äúproperties‚Äù -</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span> <span class="na">p1</span><span class="p">:</span> <span class="mh">0x11223344</span><span class="p">,</span> <span class="na">p2</span><span class="p">:</span> <span class="dl">"</span><span class="s2">STRING</span><span class="dl">"</span><span class="p">,</span> <span class="na">p3</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">p4</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.2</span><span class="p">,</span><span class="mf">3.8</span><span class="p">]};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>In the above example p1, p2, p3 and p4 are ‚Äúproperties‚Äù of the object <code class="language-plaintext highlighter-rouge">obj</code>. They are like python dictionaries. Each property has a value mapped to it. This can be of any type, int, string, Boolean, object etc. Such objects are represented in the memory as objects of the <code class="language-plaintext highlighter-rouge">JSObject</code> class.</p>

<p>The following is an abstraction of the NativeObject class, which inherits the <code class="language-plaintext highlighter-rouge">JSObject</code> among other class -</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">NativeObject</span>
<span class="p">{</span>
    <span class="n">js</span><span class="o">::</span><span class="n">GCPtrObjectGroup</span> <span class="n">group_</span><span class="p">;</span>
    <span class="kt">void</span><span class="o">*</span> <span class="n">shapeOrExpando_</span><span class="p">;</span>
    <span class="n">js</span><span class="o">::</span><span class="n">HeapSlot</span> <span class="o">*</span><span class="n">slots_</span><span class="p">;</span>
    <span class="n">js</span><span class="o">::</span><span class="n">HeapSlot</span> <span class="o">*</span><span class="n">elements_</span><span class="p">;</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Lets discuss each of these fields with some more detail.</p>

<h4 id="group_">group_</h4>

<p>I did not fully understand the requirement and the use of the <code class="language-plaintext highlighter-rouge">group_</code> member but I did come across the following comment in <code class="language-plaintext highlighter-rouge">js/src/vm/JSObject.h</code></p>

<blockquote>
  <p>The |group_| member stores the group of the object, which contains its prototype object, its class and the possible types of its properties.</p>
</blockquote>

<p>~I would be glad if anyone could explain more about this field.~ (Updated now)</p>

<p>The <code class="language-plaintext highlighter-rouge">group_</code> member is essentially a member of the <code class="language-plaintext highlighter-rouge">ObjectGroup</code> class, with the following members.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>    <span class="cm">/* Class shared by objects in this group. */</span>
    <span class="k">const</span> <span class="n">Class</span><span class="o">*</span> <span class="n">clasp_</span><span class="p">;</span> <span class="c1">// set by constructor</span>

    <span class="cm">/* Prototype shared by objects in this group. */</span>
    <span class="n">GCPtr</span><span class="o">&lt;</span><span class="n">TaggedProto</span><span class="o">&gt;</span> <span class="n">proto_</span><span class="p">;</span> <span class="c1">// set by constructor</span>

    <span class="cm">/* Realm shared by objects in this group. */</span>
    <span class="n">JS</span><span class="o">::</span><span class="n">Realm</span><span class="o">*</span> <span class="n">realm_</span><span class="p">;;</span> <span class="c1">// set by constructor</span>

    <span class="cm">/* Flags for this group. */</span>
    <span class="n">ObjectGroupFlags</span> <span class="n">flags_</span><span class="p">;</span> <span class="c1">// set by constructor</span>

    <span class="c1">// If non-null, holds additional information about this object, whose</span>
    <span class="c1">// format is indicated by the object's addendum kind.</span>
    <span class="kt">void</span><span class="o">*</span> <span class="n">addendum_</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>

    <span class="n">Property</span><span class="o">**</span> <span class="n">propertySet</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The comments more or less explain the use of each of the fields, but let me just go into the <code class="language-plaintext highlighter-rouge">clasp_</code> member as it provides interesting targets for exploitation.</p>

<p>Like the comments says, this defines the JSClass that is shared by all objects that belong to this group and can be used to identify this group. Let‚Äôs take a look at the <code class="language-plaintext highlighter-rouge">Class</code> structure.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>
<span class="k">struct</span> <span class="nc">MOZ_STATIC_CLASS</span> <span class="n">Class</span>
<span class="p">{</span>
    <span class="n">JS_CLASS_MEMBERS</span><span class="p">(</span><span class="n">js</span><span class="o">::</span><span class="n">ClassOps</span><span class="p">,</span> <span class="n">FreeOp</span><span class="p">);</span>
    <span class="k">const</span> <span class="n">ClassSpec</span><span class="o">*</span> <span class="n">spec</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">ClassExtension</span><span class="o">*</span> <span class="n">ext</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">ObjectOps</span><span class="o">*</span> <span class="n">oOps</span><span class="p">;</span>
    <span class="o">:</span>
    <span class="o">:</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I did not understand much of the other properties except the <code class="language-plaintext highlighter-rouge">ClassOps</code>, but I‚Äôll update it here once I do. <code class="language-plaintext highlighter-rouge">ClassOps</code> is basically a pointer to a structure that holds a number of function pointers that define how specific operations on an object take place (!? Lol, don‚Äôt worry, example coming right up!). Let‚Äôs take a look at this <code class="language-plaintext highlighter-rouge">ClassOps</code> structure</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>
<span class="k">struct</span> <span class="nc">MOZ_STATIC_CLASS</span> <span class="n">ClassOps</span>
<span class="p">{</span>
    <span class="cm">/* Function pointer members (may be null). */</span>
    <span class="n">JSAddPropertyOp</span>     <span class="n">addProperty</span><span class="p">;</span>
    <span class="n">JSDeletePropertyOp</span>  <span class="n">delProperty</span><span class="p">;</span>
    <span class="n">JSEnumerateOp</span>       <span class="n">enumerate</span><span class="p">;</span>
    <span class="n">JSNewEnumerateOp</span>    <span class="n">newEnumerate</span><span class="p">;</span>
    <span class="n">JSResolveOp</span>         <span class="n">resolve</span><span class="p">;</span>
    <span class="n">JSMayResolveOp</span>      <span class="n">mayResolve</span><span class="p">;</span>
    <span class="n">FinalizeOp</span>          <span class="n">finalize</span><span class="p">;</span>
    <span class="n">JSNative</span>            <span class="n">call</span><span class="p">;</span>
    <span class="n">JSHasInstanceOp</span>     <span class="n">hasInstance</span><span class="p">;</span>
    <span class="n">JSNative</span>            <span class="n">construct</span><span class="p">;</span>
    <span class="n">JSTraceOp</span>           <span class="n">trace</span><span class="p">;</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>For example the function pointer in the <code class="language-plaintext highlighter-rouge">addProperty</code> field, defines which function is to be called when a new property is called. This is all explained pretty nicely in <a href="https://doar-e.github.io/blog/2018/11/19/introduction-to-spidermonkey-exploitation/">this post</a>. Its a really great article especially for someone starting out with SpiderMonkey exploitation and the author explains everything from scratch. So back to the point, we basically have an array of function pointers here. If we manage to overwrite any of them, we can convert an arbitrary write into arbitrary code execution.</p>

<p>But wait its not that easy. The thing is that this region which contains the function pointers is an <code class="language-plaintext highlighter-rouge">r-x</code> region (no write access). But, provided that we have arbitrary write, we can easily fake the entire <code class="language-plaintext highlighter-rouge">ClassOps</code> structure and overwrite the pointer to the actual <code class="language-plaintext highlighter-rouge">ClassOps</code> in the <code class="language-plaintext highlighter-rouge">group</code> field with a pointer to our fake structure.</p>

<p>Thus we have here a means to get code execution provided we have arbitrary write. This will be handy later!</p>

<h4 id="shape_-and-slots_">shape_ and slots_</h4>

<p>So how does js keep track of the <code class="language-plaintext highlighter-rouge">properties</code> of an object? Just consider the following snippet.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nx">obj</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">blahblah</span> <span class="o">=</span> <span class="mh">0x55667788</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">strtest</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">TESTSTRING</span><span class="dl">"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">obj</code> is an array but it has a couple of properties as well. Now we js has to keep track of the property names as well as their values. For this it uses the <code class="language-plaintext highlighter-rouge">shape_</code> and the the <code class="language-plaintext highlighter-rouge">slots_</code> field of the object. The <code class="language-plaintext highlighter-rouge">slots_</code> field is the one that contains the values that are associated with each property. It is basically an array that contains only the values (no names). The <code class="language-plaintext highlighter-rouge">shape_</code> contains the name of the property as well as an index into the <code class="language-plaintext highlighter-rouge">slots_</code> array where the value for this property will be present.</p>

<p>Maybe the following pic explains better than I do :)</p>

<p><img src="/assets/img/spidermonkey/shape.png" alt="shape" /></p>

<p>Okay, so lets a look at what‚Äôs happening in the memory with gdb.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">xg</span> <span class="mh">0x7f7f01b90120</span>
<span class="mh">0x7f7f01b90120</span><span class="p">:</span>	<span class="mh">0x00007f7f01b8a310</span>	<span class="mh">0x00007f7f01bb18d0</span> <span class="o">----&gt;</span> <span class="n">shape_</span>
<span class="mh">0x7f7f01b90130</span><span class="p">:</span>	<span class="mh">0x00007f7f01844ec0</span>	<span class="mh">0x000000000174a490</span>
                        <span class="o">|</span>
                        <span class="o">+----------------------------------&gt;</span> <span class="n">slots_</span>

<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">tel</span> <span class="mh">0x00007f7f01bb18d0</span> <span class="mi">4</span>
<span class="mi">0000</span><span class="o">|</span> <span class="mh">0x7f7f01bb18d0</span> <span class="o">--&gt;</span> <span class="mh">0x7f7f01b8b0e0</span> <span class="o">--&gt;</span> <span class="mh">0x2a26380</span> <span class="p">(:</span><span class="n">PlainObject</span><span class="p">::</span><span class="n">class_</span><span class="o">&gt;</span><span class="p">:</span>	<span class="mh">0x000000000162a4bf</span><span class="p">)</span>
<span class="mi">0008</span><span class="o">|</span> <span class="mh">0x7f7f01bb18d8</span> <span class="o">--&gt;</span> <span class="mh">0x7f7f01bae6c0</span> <span class="o">--&gt;</span> <span class="mh">0x70000004a</span>  <span class="c1"># Property Name
</span><span class="mi">0016</span><span class="o">|</span> <span class="mh">0x7f7f01bb18e0</span> <span class="o">--&gt;</span> <span class="mh">0xfffe000100000001</span> <span class="c1"># Index in slots_ array is '1' (last 3 bytes)
</span><span class="mi">0024</span><span class="o">|</span> <span class="mh">0x7f7f01bb18e8</span> <span class="o">--&gt;</span> <span class="mh">0x7f7f01bb18a8</span> <span class="o">--&gt;</span> <span class="mh">0x7f7f01b8b0e0</span> <span class="o">--&gt;</span> <span class="mh">0x2a26380</span> <span class="p">(:</span><span class="n">PlainObject</span><span class="p">::</span><span class="n">class_</span><span class="o">&gt;</span><span class="p">:</span>	<span class="mh">0x000000000162a4bf</span><span class="p">)</span>
                              <span class="o">|</span>
                              <span class="o">+-----&gt;</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">shape</span>

<span class="c1"># Looking at the property name.
</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="n">wx</span> <span class="mh">0x7f7f01bae6c0</span>
<span class="mh">0x7f7f01bae6c0</span><span class="p">:</span>	<span class="mh">0x0000004a</span>	<span class="mh">0x00000007</span> <span class="c1"># metadata of the string. 0x4a is flag I think and 7 is the length of string.
</span><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="n">s</span>
<span class="mh">0x7f7f01bae6c8</span><span class="p">:</span>	<span class="s">"strtest"</span> <span class="c1"># The last property added, is at the head of the linked list.
</span>
<span class="c1"># The next pointer
</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">tel</span> <span class="mh">0x7f7f01bb18a8</span> <span class="mi">4</span>
<span class="mi">0000</span><span class="o">|</span> <span class="mh">0x7f7f01bb18a8</span> <span class="o">--&gt;</span> <span class="mh">0x7f7f01b8b0e0</span> <span class="o">--&gt;</span> <span class="mh">0x2a26380</span> <span class="p">(:</span><span class="n">PlainObject</span><span class="p">::</span><span class="n">class_</span><span class="o">&gt;</span><span class="p">:</span>	<span class="mh">0x000000000162a4bf</span><span class="p">)</span>
<span class="mi">0008</span><span class="o">|</span> <span class="mh">0x7f7f01bb18b0</span> <span class="o">--&gt;</span> <span class="mh">0x7f7f01bae6a0</span> <span class="o">--&gt;</span> <span class="mh">0x80000004a</span>
<span class="mi">0016</span><span class="o">|</span> <span class="mh">0x7f7f01bb18b8</span> <span class="o">--&gt;</span> <span class="mh">0xfffe000102000000</span>
<span class="mi">0024</span><span class="o">|</span> <span class="mh">0x7f7f01bb18c0</span> <span class="o">--&gt;</span> <span class="mh">0x7f7f01b8cb78</span> <span class="o">--&gt;</span> <span class="mh">0x7f7f01b8b0e0</span> <span class="o">--&gt;</span> <span class="mh">0x2a26380</span> <span class="p">(:</span><span class="n">PlainObject</span><span class="p">::</span><span class="n">class_</span><span class="o">&gt;</span><span class="p">:</span>	<span class="mh">0x000000000162a4bf</span><span class="p">)</span>

<span class="c1"># Name of the property
</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="n">xg</span> <span class="mh">0x7f7f01bae6a0</span>
<span class="mh">0x7f7f01bae6a0</span><span class="p">:</span>	<span class="mh">0x000000080000004a</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="n">s</span>
<span class="mh">0x7f7f01bae6a8</span><span class="p">:</span>	<span class="s">"blahblah"</span>

<span class="c1"># The slots_ array
</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="n">xg</span> <span class="mh">0x00007f7f01844ec0</span>
<span class="mh">0x7f7f01844ec0</span><span class="p">:</span>	<span class="mh">0xfff8800055667788</span> <span class="c1"># index 0 which is value for the property "blahblah"
</span><span class="mh">0x7f7f01844ec8</span><span class="p">:</span>	<span class="mh">0xfffb7f7f01bae6e0</span> <span class="c1"># index 1 which is value for the property "strtest". This is a string object.
</span>
<span class="c1"># Dereference index 1, which is a pointer to 0x7f7f01bae6e0
</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="n">xg</span> <span class="mh">0x7f7f01bae6e0</span>
<span class="mh">0x7f7f01bae6e0</span><span class="p">:</span>	<span class="mh">0x0000000a0000004a</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="n">s</span>
<span class="mh">0x7f7f01bae6e8</span><span class="p">:</span>	<span class="s">"TESTSTRING"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="elements_">elements_</h4>

<p>Now in the example that we took in the previous section, the object just had a few properties. What if it had elements as well? Lets add to the above snippet -</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nx">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mh">0x11223344</span>
<span class="nx">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mh">0x33557711</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Yep, you guessed it right. The elements are going to be stored in an array pointed to by the <code class="language-plaintext highlighter-rouge">elements_</code> member. Lets take a look at a modified image.</p>

<p><img src="/assets/img/spidermonkey/elements.png" alt="elements" /></p>

<p>And in gdb -</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>
<span class="c1"># This time we have all previous pointers plus a pointer to the elements_ array
</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">xg</span> <span class="mh">0x7f7f01b90120</span>
<span class="mh">0x7f7f01b90120</span><span class="p">:</span>	<span class="mh">0x00007f7f01b8a310</span>	<span class="mh">0x00007f7f01bb18d0</span>
<span class="mh">0x7f7f01b90130</span><span class="p">:</span>	<span class="mh">0x00007f7f01844ec0</span>	<span class="mh">0x00007f7f01844f90</span> <span class="o">---&gt;</span> <span class="n">elements_</span>

<span class="c1"># The array -
</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="n">xg</span> <span class="mh">0x00007f7f01844f90</span>
<span class="mh">0x7f7f01844f90</span><span class="p">:</span>	<span class="mh">0xfff8800011223344</span>  <span class="c1"># index 0
</span><span class="mh">0x7f7f01844f98</span><span class="p">:</span>	<span class="mh">0xfff8800033557711</span>  <span class="c1"># index 0
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>Now we saw that we can add any number of elements to objects. So the elements_ array has a metadata to keep track of no. of elements etc (This is actually casted to ObjectElements explicitly. Check <code class="language-plaintext highlighter-rouge">js/src/vm/NativeObject.h</code> for details). The following constitute the metadata -</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kt">uint32_t</span> <span class="n">flags</span><span class="p">;</span>

<span class="cm">/*
 * Number of initialized elements. This is &lt;= the capacity, and for arrays
 * is &lt;= the length. Memory for elements above the initialized length is
 * uninitialized, but values between the initialized length and the proper
 * length are conceptually holes.
 */</span>
<span class="kt">uint32_t</span> <span class="n">initializedLength</span><span class="p">;</span>

<span class="cm">/* Number of allocated slots. */</span>
<span class="kt">uint32_t</span> <span class="n">capacity</span><span class="p">;</span>

<span class="cm">/* 'length' property of array objects, unused for other objects. */</span>
<span class="kt">uint32_t</span> <span class="n">length</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The above code is from the definition of ObjectElements in NativeObject.h. The comments are self explanatory I guess. Lets add a couple more elements to our <code class="language-plaintext highlighter-rouge">obj</code> object‚Ä¶</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nx">obj</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="dl">"</span><span class="s2">asdfasdf</span><span class="dl">"</span>
<span class="nx">obj</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mf">6.022</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>‚Ä¶and view this in gdb.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">xg</span> <span class="mh">0x7f7f01b90120</span>
<span class="mh">0x7f7f01b90120</span><span class="p">:</span>	<span class="mh">0x00007f7f01b8a310</span>	<span class="mh">0x00007f7f01bb18d0</span>
<span class="mh">0x7f7f01b90130</span><span class="p">:</span>	<span class="mh">0x00007f7f01844ec0</span>	<span class="mh">0x00007f7f01844f90</span>

<span class="c1"># size of the metadata is 0x10 bytes
</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">wx</span> <span class="mh">0x00007f7f01844f90</span><span class="o">-</span><span class="mh">0x10</span>
                      <span class="n">Flags</span>       <span class="n">init_len</span>      <span class="n">capacity</span>      <span class="n">length</span>
<span class="mh">0x7f7f01844f80</span><span class="p">:</span>	<span class="mh">0x00000000</span>	<span class="mh">0x00000004</span>	<span class="mh">0x00000006</span>	<span class="mh">0x00000000</span>

<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">xg</span>
<span class="mh">0x7f7f01844f90</span><span class="p">:</span>	<span class="mh">0xfff8800011223344</span>	<span class="mh">0xfff8800033557711</span>
<span class="mh">0x7f7f01844fa0</span><span class="p">:</span>	<span class="mh">0xfffb7f7f01bae720</span>	<span class="mh">0x401816872b020c4a</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="typed-arrays">Typed Arrays</h2>

<p>From the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Typed_arrays">MDN</a> page</p>

<blockquote>
  <p>The <code class="language-plaintext highlighter-rouge">ArrayBuffer</code> is a data type that is used to represent a generic, fixed-length binary data buffer. You can‚Äôt directly manipulate the contents of an <code class="language-plaintext highlighter-rouge">ArrayBuffer</code>; instead, you create a typed array view or a <code class="language-plaintext highlighter-rouge">DataView</code> which represents the buffer in a specific format, and use that to read and write the contents of the buffer.</p>
</blockquote>

<p>All the attribute of the <code class="language-plaintext highlighter-rouge">NativeObject</code> are inherited by the <code class="language-plaintext highlighter-rouge">ArrayBufferObject</code>. In addition the <code class="language-plaintext highlighter-rouge">ArrayBufferObject</code> has the following -</p>

<ul>
  <li><strong>Pointer to data:</strong> Pointer to the data buffer of the ArrayBuffer in the ‚Äúprivate‚Äù form.</li>
  <li><strong>length:</strong> Size of the buffer.</li>
  <li><strong>First View:</strong> Pointer to the first view that references the current ArrayBuffer.</li>
  <li><strong>flags</strong></li>
</ul>

<p>The pointer to the data buffer is stored in the private form, the <code class="language-plaintext highlighter-rouge">setPrivate</code> being,</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">setPrivate</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">MOZ_ASSERT</span><span class="p">((</span><span class="kt">uintptr_t</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#if defined(JS_NUNBOX32)
</span>    <span class="n">s_</span><span class="p">.</span><span class="n">tag_</span> <span class="o">=</span> <span class="n">JSValueTag</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">s_</span><span class="p">.</span><span class="n">payload_</span><span class="p">.</span><span class="n">ptr_</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
<span class="cp">#elif defined(JS_PUNBOX64)
</span>    <span class="n">asBits_</span> <span class="o">=</span> <span class="kt">uintptr_t</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif
</span>    <span class="n">MOZ_ASSERT</span><span class="p">(</span><span class="n">isDouble</span><span class="p">());</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>‚Ä¶which is basically this :) -</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">setPrivate</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">asBits_</span> <span class="o">=</span> <span class="kt">uintptr_t</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Thus it is right shifted by 1. (We‚Äôll check it out in gdb soon)</p>

<p>Now lets create an ArrayBuffer and add a view to this buffer.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="nx">arrbuf</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>        <span class="c1">// ArrayBuffer of size 0x100 bytes.</span>
<span class="nx">uint32view</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint32Array</span><span class="p">(</span><span class="nx">arrbuf</span><span class="p">);</span>   <span class="c1">// Adding a Uint32 view.</span>
<span class="nx">uint16view</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint16Array</span><span class="p">(</span><span class="nx">arrbuf</span><span class="p">);</span>   <span class="c1">// Adding another view - this time a Uint16 one.</span>
<span class="nx">uint32view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mh">0x11223344</span>                <span class="c1">// Initialize the buffer with a value.</span>

<span class="nx">uint32view</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="c1">// Outputs "11223344"</span>

<span class="cm">/* Lets check the Uint16Array */</span>

<span class="nx">uint16view</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="c1">// Outputs "3344"</span>

<span class="nx">uint16view</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="c1">// Outputs "1122"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The different views on the same buffer allow us to look at the data in the buffer in different ways. A <code class="language-plaintext highlighter-rouge">TypedArray</code> like an <code class="language-plaintext highlighter-rouge">ArrayBuffer</code> has the following extra attributes, in addition to <code class="language-plaintext highlighter-rouge">NativeObject</code></p>

<ul>
  <li><strong>Underlying ArrayBuffer:</strong> Pointer to the ArrayBuffer that holds the data for this typed array</li>
  <li><strong>length:</strong> The length of the array. If ArrayBuffer is 0x20 bytes and this is a Uint32Array, length=0x20/4 = 8.</li>
  <li><strong>offset</strong></li>
  <li><strong>pointer to data:</strong> This is the pointer to the data buffer in the raw form for enhancing performance.</li>
</ul>

<p>Lets start looking at how all this is represented in the memory.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">8</span><span class="n">xg</span> <span class="mh">0x7f618109a080</span>
<span class="mh">0x7f618109a080</span><span class="p">:</span>	<span class="mh">0x00007f618108a8b0</span> <span class="p">(</span><span class="n">group_</span><span class="p">)</span>       <span class="mh">0x00007f61810b1a38</span> <span class="p">(</span><span class="n">shape_</span><span class="p">)</span>
<span class="mh">0x7f618109a090</span><span class="p">:</span>	<span class="mh">0x0000000000000000</span> <span class="p">(</span><span class="n">slots_</span><span class="p">)</span>       <span class="mh">0x000000000174a490</span> <span class="p">(</span><span class="n">elements_</span><span class="p">)</span>
<span class="mh">0x7f618109a0a0</span><span class="p">:</span>	<span class="mh">0x00003fb0c0d34b00</span> <span class="p">(</span><span class="n">data</span> <span class="n">pointer</span><span class="p">)</span> <span class="mh">0xfff8800000000100</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span>
<span class="mh">0x7f618109a0b0</span><span class="p">:</span>	<span class="mh">0xfffe7f6183d003a0</span> <span class="p">(</span><span class="n">first</span> <span class="n">view</span><span class="p">)</span>   <span class="mh">0xfff8800000000008</span> <span class="p">(</span><span class="n">flags</span><span class="p">)</span>

<span class="c1"># The data pointer
</span><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">p</span><span class="o">/</span><span class="n">x</span> <span class="mh">0x00003fb0c0d34b00</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
<span class="err">$</span><span class="mi">2</span> <span class="o">=</span> <span class="mh">0x7f6181a69600</span>

<span class="c1"># The buffer
</span><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="n">xg</span> <span class="mh">0x7f6181a69600</span>
<span class="mh">0x7f6181a69600</span><span class="p">:</span>	<span class="mh">0x0000000011223344</span>	<span class="mh">0x0000000000000000</span>

<span class="c1"># The Uint32 Array
</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">8</span><span class="n">xg</span> <span class="mh">0x7f6183d003a0</span>
<span class="mh">0x7f6183d003a0</span><span class="p">:</span>	<span class="mh">0x00007f618108aa30</span>              	<span class="mh">0x00007f61810b4a60</span>
<span class="mh">0x7f6183d003b0</span><span class="p">:</span>	<span class="mh">0x0000000000000000</span>              	<span class="mh">0x000000000174a490</span>
<span class="mh">0x7f6183d003c0</span><span class="p">:</span>	<span class="mh">0xfffe7f618109a080</span> <span class="p">(</span><span class="n">ArrayBuffer</span><span class="p">)</span>	<span class="mh">0xfff8800000000040</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span>
<span class="mh">0x7f6183d003d0</span><span class="p">:</span>	<span class="mh">0xfff8800000000000</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span>      	<span class="mh">0x00007f6181a69600</span> <span class="p">(</span><span class="n">Pointer</span> <span class="n">to</span> <span class="n">data</span> <span class="nb">buffer</span><span class="p">)</span>

<span class="c1"># The Uint16 Array
</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">8</span><span class="n">xg</span> <span class="mh">0x7f6183d003e0</span>
<span class="mh">0x7f6183d003e0</span><span class="p">:</span>	<span class="mh">0x00007f618108aaf0</span>              	<span class="mh">0x00007f61810b4ba0</span>
<span class="mh">0x7f6183d003f0</span><span class="p">:</span>	<span class="mh">0x0000000000000000</span>              	<span class="mh">0x000000000174a490</span>
<span class="mh">0x7f6183d00400</span><span class="p">:</span>	<span class="mh">0xfffe7f618109a080</span> <span class="p">(</span><span class="n">ArrayBuffer</span><span class="p">)</span>	<span class="mh">0xfff8800000000080</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span>
<span class="mh">0x7f6183d00410</span><span class="p">:</span>	<span class="mh">0xfff8800000000000</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span>      	<span class="mh">0x00007f6181a69600</span> <span class="p">(</span><span class="n">Pointer</span> <span class="n">to</span> <span class="n">data</span> <span class="nb">buffer</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>Since the data in the TypedArrays are saved without nan-boxing and as the C native types, this is really useful in exploitation, where we might feel the need to read and write data to and from arbitrary location. Now, imagine that you have control over the data pointer of an ArrayBuffer. Thus you can read and write 4 bytes at a time, to and from an arbitrary location by assigning a <code class="language-plaintext highlighter-rouge">Uint32Array</code> with the corrupted ArrayBuffer. If, instead, we use a normal array for this then the data read from arbitrary location would be in float and to write data to the location we would need to give the payload in float instead of int.</p>

<h2 id="epilogue">Epilogue</h2>

<p>So that kind of summarizes what I have learned so far :). When I get some more free time I plan to write a writeup for <code class="language-plaintext highlighter-rouge">blazefox</code> which is a pretty easy challenge and a really good one to try out for starting with browser related exploitation.</p>

<p>I know that this is still incomplete and probably error ridden. If you spot any mistake in the post I would be glad to correct it.</p>

<h2 id="references">References</h2>

<ul>
  <li><a href="http://www.phrack.org/issues/69/14.html">OR‚ÄôLYEH? The Shadow over Firefox</a> by <a href="https://twitter.com/_argp">argp</a>.</li>
  <li><a href="https://bruce30262.github.io/Learning-browser-exploitation-via-33C3-CTF-feuerfuchs-challenge/">Learning browser exploitation via 33C3 CTF feuerfuchs challenge</a></li>
  <li><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Build_Documentation">Building SpiderMonkey</a></li>
  <li>SpiderMonkey Source Code</li>
</ul>
:ET