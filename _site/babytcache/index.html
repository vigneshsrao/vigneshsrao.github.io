<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
    <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <title>HITCON CTF: baby_tcache Writeup &#8211; sherl0ck's home</title>
    <meta name="description" content="Allocate chunk in stdout-&gt;_flags and partial overwrite _IO_write_base to get leak.">
    <meta name="keywords" content="writeup, tcache, heap, filestructure">
    <link rel="canonical" href="http://localhost:4000/babytcache/">
        <!-- Twitter Cards -->
    <meta name="twitter:title" content="HITCON CTF: baby_tcache Writeup">
    <meta name="twitter:description" content="Allocate chunk in stdout-&gt;_flags and partial overwrite _IO_write_base to get leak.">
    <meta name="twitter:site" content="@sherl0ck__">
    <meta name="twitter:creator" content="@sherl0ck__">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="http://localhost:4000/assets/img/profile.png">
    <!-- Open Graph -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="HITCON CTF: baby_tcache Writeup">
    <meta property="og:description" content="Allocate chunk in stdout-&gt;_flags and partial overwrite _IO_write_base to get leak.">
    <meta property="og:url" content="http://localhost:4000/babytcache/">
    <meta property="og:site_name" content="sherl0ck's home">
    <meta property="og:image" content="http://localhost:4000/assets/img/profile.png">

    
    
    <!-- Handheld -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicons -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="http://localhost:4000/assets/img/favicon/apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/assets/img/favicon/apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/assets/img/favicon/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/assets/img/favicon/apple-touch-icon-144x144.png" />
<link rel="icon" type="image/png" href="http://localhost:4000/assets/img/favicon/favicon.png" />
<link rel="shortcut icon" href="http://localhost:4000/assets/img/favicon/favicon.png" />

    <!-- Feed -->
    <link rel="alternate" type="application/rss+xml" title="sherl0ck's home" href="http://localhost:4000/feed.xml" />
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/main.css">
</head>

  <body>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript">
      $(function() {
        i = 0;
        $('.menuAc').css({
          'color': 'rgba(52, 152, 219, 1)'
        });
        $('.menuAc').click(function(){
          $(this).next('.menuMobil').animate({width:'toggle'},350);
          if (i%2==0) {
            $('.footer').css({
              'filter'         : 'blur(5px)'
            });
            $('.yazilar').css({
              'filter'         : 'blur(5px)'
            });
            $('.ust').css({
              'filter'         : 'blur(5px)'
            });
            $('ul.menu').css({
              'animation-duration': '0.1s'
            });
            i++;
          }
          else {
            $('.footer').css({
              'filter'         : 'blur(0px)'
            });
            $('.yazilar').css({
              'filter'         : 'blur(0px)'
            });
            $('.ust').css({
              'filter'         : 'blur(0px)'
            });
            i++;
          }

        });
      });
    </script>

    <div class="menuAc">
      <i class="fa fa-bars" aria-hidden="true"></i>
    </div>
    <div class="menuMobil">
          <nav class="nav-home">
      <ul class="menu">
            
				    
				    <li><a class="link" href="http://localhost:4000/" >Home</a></li>
				
				    
				    <li><a class="link" href="http://localhost:4000/blog/" >Blog</a></li>
				
				    
				    <li><a class="link" href="http://localhost:4000/projects/" >Projects</a></li>
				
				    
				    <li><a class="link" href="http://localhost:4000/about/" >About</a></li>
				
				    
				    <li><a class="link" href="http://localhost:4000/resume.pdf" >Resume</a></li>
				
        </ul>
    </nav>

    </div>
    <!-- <div class="sidenav"> -->
    <!-- </div> -->

    <!-- <div class="asdf"> -->
    <div class="ust">
      <div class="ortalaAna">
        <div class="baslikAna">
          sherl0ck's home
        </div>

        <div class="pc">
              <nav class="nav">
        <ul class="menuAna">
            
				    
				    <li class="item"><a class="link" href="http://localhost:4000/" >Home</a></li>
				
				    
				    <li class="item"><a class="link" href="http://localhost:4000/blog/" >Blog</a></li>
				
				    
				    <li class="item"><a class="link" href="http://localhost:4000/projects/" >Projects</a></li>
				
				    
				    <li class="item"><a class="link" href="http://localhost:4000/about/" >About</a></li>
				
				    
				    <li class="item"><a class="link" href="http://localhost:4000/resume.pdf" >Resume</a></li>
				
        </ul>
    </nav>

        </div>
      </div>
    </div>
  <!-- </div> -->

    <div class="ortalaAna">
      <div class="yazilar">
        <div class="yazi">
          <div class="ustr">
            <h2>HITCON CTF: baby_tcache Writeup</h2>
            <div class="yazibilgisi">
              25 Oct 2018
            </div>

          </div>
          <hr>
          <div class="content">
            <div class="entry">
            <div class=".post-tag">
              
              <i class="fa fa-tags" float=right></i>
              
              <a href="/blog/tag/#writeup"   class="post-tag">writeup</a>
              
              <a href="/blog/tag/#tcache"   class="post-tag">tcache</a>
              
              <a href="/blog/tag/#heap"   class="post-tag">heap</a>
              
              <a href="/blog/tag/#filestructure"   class="post-tag">filestructure</a>
              
              
            </div>

            <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

            <!-- <div class="sidenav"> -->
            <!-- <div class="notice"> -->

            <nav class="toc">
            <header>
            <h2 class="nav__title">
            <i class="fas fa-file-alt"> Contents</i>
            </h2>
            </header>
            <!-- <div id="markdown-toc"> -->
            <ul>
  <li><a href="#reversing">Reversing</a></li>
  <li><a href="#vulnerability">Vulnerability</a></li>
  <li><a href="#exploit">Exploit</a></li>
</ul>

            <!-- </div> -->
            </nav>
            <!-- </div> -->
            <p><strong>Attachments</strong>: <a href="/assets/img/baby_tcache/baby_tcache">binary</a>     <a href="/assets/img/baby_tcache/libc.so.6">libc</a>     <a href="/assets/img/baby_tcache/exploit.py">exploit</a></p>

<p>This was a really fun challenge created by angelboy for HITCON CTF 2018. The following will be a writeup for the intended solution as gathered from the <a href="https://github.com/scwuaptx/CTF/blob/master/2018-writeup/hitcon/baby_tcache.py">exploit script</a> that <a href="https://twitter.com/scwuaptx">angelboy</a> uploaded.</p>

<p class="notice"><strong>Note:</strong> During the CTF we solved this challenge in a really impractical way (brute-forcing 12 bit’s of libc address to get to <code class="highlighter-rouge">__free_hook</code> and <code class="highlighter-rouge">one_gadget</code>). The intended solution is really pretty cool as it involves getting a leak which looked impossible at the start.</p>

<p>So, the binary that was provided was a stripped ELF 64 bit using libc version 2.27. The specialty of this version of libc is that, it implements the <code class="highlighter-rouge">tcache</code> concept that is used to cache free chunks in the heap before adding them to the libc freelist. Here are the mitigations enforced.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">gdb</span><span class="o">-</span><span class="nx">peda$</span> <span class="nx">checksec</span>
  <span class="nx">CANARY</span>    <span class="p">:</span> <span class="nx">ENABLED</span>
  <span class="nx">FORTIFY</span>   <span class="p">:</span> <span class="nx">ENABLED</span>
  <span class="nx">NX</span>        <span class="p">:</span> <span class="nx">ENABLED</span>
  <span class="nx">PIE</span>       <span class="p">:</span> <span class="nx">ENABLED</span>
  <span class="nx">RELRO</span>     <span class="p">:</span> <span class="nx">FULL</span>
</code></pre></div></div>

<h2 id="reversing">Reversing</h2>

<p>Reversing this binary is pretty easy. There are only 2 functionalities</p>
<ul>
  <li><strong>new_heap:</strong> mallocs a chunk of user specified size and reads data into it. It then adds this chunk into a global array (lets call it <code class="highlighter-rouge">table</code>) and the size into another global array (say <code class="highlighter-rouge">size_arr</code>).</li>
  <li><strong>delete_heap:</strong> memsets <code class="highlighter-rouge">size</code> bytes of the chunk with the byte 0xda and then frees the chunk.</li>
</ul>

<h2 id="vulnerability">Vulnerability</h2>

<p>In the <code class="highlighter-rouge">new_heap</code> function, after reading <code class="highlighter-rouge">size</code> bytes of input from the user, chunk[size] is set to zero. This leads to a null-byte overflow in the <code class="highlighter-rouge">size</code> field of the next chunk if <code class="highlighter-rouge">size</code> corresponds to the exact size of the heap chunk.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">printf</span><span class="p">(</span><span class="s">"Data:"</span><span class="p">);</span>
<span class="n">getinp</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="n">v6</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// Null byte overflow
</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v6</span><span class="p">;</span>
<span class="n">v3</span> <span class="o">=</span> <span class="n">size_array</span><span class="p">;</span>
</code></pre></div></div>

<p>Thus we can use this to set the <code class="highlighter-rouge">PREV_IN_USE</code> bit of the next chunk to zero and achieve backward coalescing somewhat like what happens in House of Einherjar.</p>

<p>The main issue is that there is no way to get a leak. There is no convenient <code class="highlighter-rouge">view</code> functionality that we can use to get a leak. Thus we have to resort to partial overwrites, at least until we manage to get a leak (yes, though it seems stunning, we will get a leak :D)</p>

<h2 id="exploit">Exploit</h2>

<p>Before actually starting off with pwning this binary, a quick note about <code class="highlighter-rouge">tcache</code>. This was a new feature introduced in glibc version 2.27 and above. Now all heap chunks of size &lt; 0x410 are treated as tcache chunks. When these are freed, they go into their respective tcache bins (a singly linked list). Each bin can hold upto 7 chunks, after which chunks are freed as they were traditionally. So all chunks of size &lt; 0x410 can be thought of as fastbin chunks. But the interesting part is that, unlike fastbin chunks tcache has <strong>no</strong> security checks in place. Thus we can double free pointers and malloc sizes without <strong>any</strong> size checks.</p>

<p>Getting back to this challenge, our plan can be to achieve a backward coalescing. But since we don’t have any leaks, we will have to use a previously freed chunk as a target in our coalescing. So first, lets malloc a chunk of size &gt; 0x410 so that we have unsorted bin pointer in the chunk. Assume we have a heap structure like this -</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  chunk 0   # size = 0x500  =&gt; Target for backward coalescing of chunk 5. This will contain unsortedbin pointers
 ----------
  chunk 1   # size = 0x40   --+
 ----------                   |
  chunk 2   # size = 0x50     |==&gt; Random tcache chunks
 ----------                   |
  chunk 3   # size = 0x60     |
 ----------                 --+
  chunk 4   # size = 0x70 =&gt; Use this for null byte overwrite of next size
 ----------
  chunk 5   # size = 0x500 =&gt; overwrite PREV_IN_USE of this chunk
 ----------
  chunk 6   # size = 0x80 =&gt; for preventing merge with topchunk
 ----------

</code></pre></div></div>
<p>For overwriting the <code class="highlighter-rouge">PREV_IN_USE</code> of chunk 5, free and reallocate chunk 4 with size 0x68 and set the <code class="highlighter-rouge">PREV_SIZE</code> so as to correspond with chunk 0 (PREV_SIZE = 0x660). After freeing chunk 5, chunk 0 will be a huge chunk with which we can overwrite the tcache chunks we created.</p>

<p>So how can we get arbitrary write from this? Well lets free chunk 2 and allocate 0x500+0x40=0x540 bytes. Thus we have unsorted bin pointer as <code class="highlighter-rouge">fd</code> of a tcache chunk. Now we allocate a chunk of any size, such that it gets serviced from the unsorted bin and overwrite the LSB of the unsorted bin pointer to point to some place we want within the libc. Note that the last three nibbles are constant, irrespective of ASLR. So to change the last 2 bytes, we have to use 4 bit bruteforce.</p>

<p>Now our aim is to get a leak. We’ll take a diversion now and start looking into the internals of <code class="highlighter-rouge">puts</code>.</p>

<p><code class="highlighter-rouge">puts</code> internally calls <code class="highlighter-rouge">_IO_new_file_xsputn</code> which eventually calls <code class="highlighter-rouge">_IO_OVERFLOW</code></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span>
<span class="nf">_IO_new_file_overflow</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_NO_WRITES</span><span class="p">)</span> <span class="cm">/* SET ERROR */</span>
    <span class="p">{</span>
      <span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>
      <span class="n">__set_errno</span> <span class="p">(</span><span class="n">EBADF</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="cm">/* If currently reading or no buffer allocated. */</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_CURRENTLY_PUTTING</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="o">:</span>
      <span class="o">:</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_IO_do_write</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">,</span>  <span class="c1">// our target
</span>			 <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">);</span>
</code></pre></div></div>
<p>We see that <code class="highlighter-rouge">_IO_do_write</code> is called eventually in this function. For this <code class="highlighter-rouge">stdout-&gt;_flags &amp; _IO_NO_WRITES</code> should be zero. Also we set <code class="highlighter-rouge">stdout-&gt;_flags &amp; _IO_CURRENTLY_PUTTING</code> to avoid some unnecessary (in our case) code.</p>

<p><code class="highlighter-rouge">_IO_new_file_overflow</code> calls <code class="highlighter-rouge">_IO_do_write</code> with arguments as <code class="highlighter-rouge">stdout</code>, <code class="highlighter-rouge">stdout-&gt;_IO_write_base</code> and size of the buffer.</p>

<p><code class="highlighter-rouge">_IO_do_write</code> calls <code class="highlighter-rouge">new_do_write</code> with same arguments.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span>
<span class="n">_IO_size_t</span>
<span class="nf">new_do_write</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">_IO_size_t</span> <span class="n">to_do</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">_IO_size_t</span> <span class="n">count</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_IS_APPENDING</span><span class="p">)</span>
    <span class="cm">/* On a system without a proper O_APPEND implementation,
       you would need to sys_seek(0, SEEK_END) here, but is
       not needed nor desirable for Unix- or Posix-like systems.
       Instead, just indicate that offset (before and after) is
       unpredictable. */</span>
    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">_IO_pos_BAD</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">!=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">_IO_off64_t</span> <span class="n">new_pos</span>
	<span class="o">=</span> <span class="n">_IO_SYSSEEK</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">new_pos</span> <span class="o">==</span> <span class="n">_IO_pos_BAD</span><span class="p">)</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">new_pos</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">count</span> <span class="o">=</span> <span class="n">_IO_SYSWRITE</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">to_do</span><span class="p">);</span> <span class="c1">// Our aim
</span>  <span class="o">:</span>
  <span class="o">:</span>
</code></pre></div></div>
<p><code class="highlighter-rouge">_IO_SYSWRITE</code> is basically <code class="highlighter-rouge">write(fp-&gt;fileno, data, to_do)</code> which is what we want. Also <code class="highlighter-rouge">_IO_SYSSEEK</code> is basically just a call to <code class="highlighter-rouge">lseek</code> on the given file with the given arguments. The issue is that we don’t exactly control <code class="highlighter-rouge">fp-&gt;_IO_write_base - fp-&gt;_IO_read_end</code>. If we set <code class="highlighter-rouge">stdout-&gt;_IO_read_end</code> to zero, then the second argument is too long, and is we set <code class="highlighter-rouge">stdout-&gt;_IO_write_base</code> &gt; <code class="highlighter-rouge">stdout-&gt;_IO_read_end</code> we’ll have issues elsewhere, owing to <code class="highlighter-rouge">_IO_write_base</code> becomming greater than <code class="highlighter-rouge">_IO_write_ptr</code>. Thus our only option is to skip the <code class="highlighter-rouge">else if</code> block. For this we have to set <code class="highlighter-rouge">stdout-&gt;_flags &amp; _IO_IS_APPENDING</code></p>

<p>Therefore to get to <code class="highlighter-rouge">_IO_SYSWRITE</code>, we need to set the flags in the following manner</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_flags</span> <span class="o">=</span> <span class="mh">0xfbad0000</span>  <span class="c1">// Magic number
</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="o">=</span> <span class="o">~</span><span class="n">_IO_NO_WRITES</span> <span class="c1">// _flags = 0xfbad0000
</span><span class="n">_flags</span> <span class="o">|</span> <span class="o">=</span> <span class="n">_IO_CURRENTLY_PUTTING</span> <span class="c1">// _flags = 0xfbad0800
</span><span class="n">_flags</span> <span class="o">|</span> <span class="o">=</span> <span class="n">_IO_IS_APPENDING</span> <span class="c1">// _flags = 0xfbad1800
</span></code></pre></div></div>

<p>By the way did you notice the second argument of <code class="highlighter-rouge">_IO_do_write</code>? It’s <code class="highlighter-rouge">_IO_write_base</code> which is eventually the second argument for <code class="highlighter-rouge">write</code>. Thus we can leak data from <code class="highlighter-rouge">stdout-&gt;_IO_write_base</code>!</p>

<p>Now all we have to do is to set <code class="highlighter-rouge">stdout-&gt;_flags</code> to the value we calculated and partial overwrite <code class="highlighter-rouge">stdout-&gt;_IO_write_base</code> so as to point it to somewhere to get a leak.</p>

<p>So we overwrite the <code class="highlighter-rouge">fd</code> of our free tcache chunk to point to <code class="highlighter-rouge">stdout-&gt;_flags</code>. Here we will hardcode the last 2 bytes. The last 3 nibbles are constant anyway so we only need to bruteforce the fourth last nibble (4-bit bruteforce). Now we allocate a junk chunk and then chunk after that will lie in our desired region. Keep in mind that there are no size checks here, so the lack of the chunk size in the target location does not cause an issue.</p>

<p>We overwrite <code class="highlighter-rouge">_flags</code> with the calculated value and <code class="highlighter-rouge">_IO_read_ptr</code>, <code class="highlighter-rouge">_IO_read_end</code>, <code class="highlighter-rouge">_IO_read_base</code> with NULL and the last byte of <code class="highlighter-rouge">_IO_write_base</code> with NULL as well.</p>

<p>Heres how <code class="highlighter-rouge">stdout</code> looked after the overwrite</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ x/28xg 0x00007ffff7dd0760
0x7ffff7dd0760 &lt;_IO_2_1_stdout_&gt;:       0x00000000fbad1800      0x0000000000000000
0x7ffff7dd0770 &lt;_IO_2_1_stdout_+16&gt;:    0x0000000000000000      0x0000000000000000
0x7ffff7dd0780 &lt;_IO_2_1_stdout_+32&gt;:    0x00007ffff7dd0700      0x00007ffff7dd07e3
0x7ffff7dd0790 &lt;_IO_2_1_stdout_+48&gt;:    0x00007ffff7dd07e3      0x00007ffff7dd07e3
0x7ffff7dd07a0 &lt;_IO_2_1_stdout_+64&gt;:    0x00007ffff7dd07e4      0x0000000000000000
0x7ffff7dd07b0 &lt;_IO_2_1_stdout_+80&gt;:    0x0000000000000000      0x0000000000000000
0x7ffff7dd07c0 &lt;_IO_2_1_stdout_+96&gt;:    0x0000000000000000      0x00007ffff7dcfa00
0x7ffff7dd07d0 &lt;_IO_2_1_stdout_+112&gt;:   0x0000000000000001      0xffffffffffffffff
0x7ffff7dd07e0 &lt;_IO_2_1_stdout_+128&gt;:   0x000000000a000000      0x00007ffff7dd18c0
0x7ffff7dd07f0 &lt;_IO_2_1_stdout_+144&gt;:   0xffffffffffffffff      0x0000000000000000
0x7ffff7dd0800 &lt;_IO_2_1_stdout_+160&gt;:   0x00007ffff7dcf8c0      0x0000000000000000
0x7ffff7dd0810 &lt;_IO_2_1_stdout_+176&gt;:   0x0000000000000000      0x0000000000000000
0x7ffff7dd0820 &lt;_IO_2_1_stdout_+192&gt;:   0x00000000ffffffff      0x0000000000000000
0x7ffff7dd0830 &lt;_IO_2_1_stdout_+208&gt;:   0x0000000000000000      0x00007ffff7dcc2a0
</code></pre></div></div>
<p>In the above structure, <code class="highlighter-rouge">_IO_write_base</code> = <code class="highlighter-rouge">0x00007ffff7dd0700</code> and <code class="highlighter-rouge">_IO_write_ptr</code> = <code class="highlighter-rouge">0x00007ffff7dd07e3</code>. So we’ll leak lot of memory in which we are sure to get a libc leak :).</p>

<p>Once we get the libc leak, exploitation is trivial. We just free another tcache chunk and overwrite its <code class="highlighter-rouge">fd</code> with a pointer to <code class="highlighter-rouge">__free_hook</code>. Then after 1 allocation of chunks in that tcache bin, we get a allocation at <code class="highlighter-rouge">__free_hook</code> and overwrite that with a <a href="https://github.com/david942j/one_gadget">one_gadget</a>.</p>

<p>After this we just call <code class="highlighter-rouge">free</code> with the <code class="highlighter-rouge">delete_heap</code> functionality to get shell!</p>

<p>We’ll have to run the exploit several times until our bruteforce pays off.</p>

<p>The flag was</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hitcon{He4p_ch41leng3s_4r3_n3v3r_d34d_XD}
</code></pre></div></div>

<p>My team (bi0s) stood 26 in this CTF. We had an awesome time trying out the challenges. Shout out to the HITCON team for organizing this CTF!</p>


            <!-- 
            <a href="/lost/" title="InCTF: lost Writeup" class="btn btn-info">&larr; Previous</a>
            
            
            <a href="/play-with-spidermonkey/" title="InCTF: lost Writeup" class="btn btn-info" style="float: right;">Next &rarr;</a>
             -->
            <!-- [ previous](https://github.com/alperenbozkurt/JBlog){: .btn .btn-info} -->

            
            <div class="PageNavigation">
              
                
                  <a class="previous" href="/lost/">&laquo; InCTF: lost Writeup</a>
                
              
              
                
                  <a class="next" href="/play-with-spidermonkey/">Playing around with SpiderMonkey &raquo;</a>
                
              
            </div>
            
            <div style="clear:both"></div>
          </div>
         	</div>

        </div>
        <script src="http://localhost:4000/assets/js/jquery-1.12.2.min.js"></script>
<script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    $.goup({
        trigger: 500,
        bottomOffset: 10,
        locationOffset: 20,
        containerRadius: 0,
        containerColor: '#fff',
        arrowColor: '#000',
        goupSpeed: 'normal'
    });
});
</script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-123721864-1']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


        
  <div id="disqus_thread" class="yazi">  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://sherl0ck.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  <script id="dsq-count-scr" src="//sherl0ck.disqus.com/count.js" async></script>


      </div>
    </div>

        <div class="footer">
      <div class="ortalaAna">
        <div class="copy">
          sherl0ck's home © 2019
        </div>
        <div class="sosyal">
                        <div class="social-links">
                  <a href="mailto:vigneshsrao5@gmail.com" class="author-social" target="_blank"><i class="fa fa-2x fa-envelope-square"></i></a>
                  <a href="http://twitter.com/sherl0ck__" class="author-social" target="_blank"><i class="fa fa-2x fa-twitter-square"></i></a>
                  
                  
                  <a href="http://linkedin.com/in/vigneshsrao" class="author-social" target="_blank"><i class="fa fa-2x fa-linkedin-square"></i></a>
                  
                  
                  
                  <a href="http://github.com/vigneshsrao" class="author-social" target="_blank"><i class="fa fa-2x fa-github"></i></a>
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
            </div>

        </div>
      </div>
    </div>

  </body>
</html>

<!-- 
<i class="previous"><a href="/lost/" title="InCTF: lost Writeup">&larr; Previous</a></i>


<i class="next"><a href="/play-with-spidermonkey/" title="Playing around with SpiderMonkey">Next &rarr;</a></i>
 -->
