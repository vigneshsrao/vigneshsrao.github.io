<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
    <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <title>SpiderMonkey Workflow Setup &#8211; sherl0ck's home</title>
    <meta name="description" content="Notes on my code review and debugging setup for SpiderMonkey">
    <meta name="keywords" content="notes, setup, spidermonkey">
    <link rel="canonical" href="http://localhost:4000/workflow/">
        <!-- Twitter Cards -->
    <meta name="twitter:title" content="SpiderMonkey Workflow Setup">
    <meta name="twitter:description" content="Notes on my code review and debugging setup for SpiderMonkey">
    <meta name="twitter:site" content="@sherl0ck__">
    <meta name="twitter:creator" content="@sherl0ck__">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="http://localhost:4000/assets/img/profile.png">
    <!-- Open Graph -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="SpiderMonkey Workflow Setup">
    <meta property="og:description" content="Notes on my code review and debugging setup for SpiderMonkey">
    <meta property="og:url" content="http://localhost:4000/workflow/">
    <meta property="og:site_name" content="sherl0ck's home">
    <meta property="og:image" content="http://localhost:4000/assets/img/profile.png">

    
    
    <!-- Handheld -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicons -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="http://localhost:4000/assets/img/favicon/apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/assets/img/favicon/apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/assets/img/favicon/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/assets/img/favicon/apple-touch-icon-144x144.png" />
<link rel="icon" type="image/png" href="http://localhost:4000/assets/img/favicon/favicon.png" />
<link rel="shortcut icon" href="http://localhost:4000/assets/img/favicon/favicon.png" />

    <!-- Feed -->
    <link rel="alternate" type="application/rss+xml" title="sherl0ck's home" href="http://localhost:4000/feed.xml" />
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/main.css">
</head>

  <body>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript">
      $(function() {
        i = 0;
        $('.menuAc').css({
          'color': 'rgba(52, 152, 219, 1)'
        });
        $('.menuAc').click(function(){
          $(this).next('.menuMobil').animate({width:'toggle'},350);
          if (i%2==0) {
            $('.footer').css({
              'filter'         : 'blur(5px)'
            });
            $('.yazilar').css({
              'filter'         : 'blur(5px)'
            });
            $('.ust').css({
              'filter'         : 'blur(5px)'
            });
            $('ul.menu').css({
              'animation-duration': '0.1s'
            });
            i++;
          }
          else {
            $('.footer').css({
              'filter'         : 'blur(0px)'
            });
            $('.yazilar').css({
              'filter'         : 'blur(0px)'
            });
            $('.ust').css({
              'filter'         : 'blur(0px)'
            });
            i++;
          }

        });
      });
    </script>

    <div class="menuAc">
      <i class="fa fa-bars" aria-hidden="true"></i>
    </div>
    <div class="menuMobil">
          <nav class="nav-home">
      <ul class="menu">
            
				    
				    <li><a class="link" href="http://localhost:4000/" >Home</a></li>
				
				    
				    <li><a class="link" href="http://localhost:4000/blog/" >Blog</a></li>
				
				    
				    <li><a class="link" href="http://localhost:4000/projects/" >Projects</a></li>
				
				    
				    <li><a class="link" href="http://localhost:4000/about/" >About</a></li>
				
				    
				    <li><a class="link" href="http://localhost:4000/resume.pdf" >Resume</a></li>
				
        </ul>
    </nav>

    </div>
    <!-- <div class="sidenav"> -->
    <!-- </div> -->

    <!-- <div class="asdf"> -->
    <div class="ust">
      <div class="ortalaAna">
        <div class="baslikAna">
          sherl0ck's home
        </div>

        <div class="pc">
              <nav class="nav">
        <ul class="menuAna">
            
				    
				    <li class="item"><a class="link" href="http://localhost:4000/" >Home</a></li>
				
				    
				    <li class="item"><a class="link" href="http://localhost:4000/blog/" >Blog</a></li>
				
				    
				    <li class="item"><a class="link" href="http://localhost:4000/projects/" >Projects</a></li>
				
				    
				    <li class="item"><a class="link" href="http://localhost:4000/about/" >About</a></li>
				
				    
				    <li class="item"><a class="link" href="http://localhost:4000/resume.pdf" >Resume</a></li>
				
        </ul>
    </nav>

        </div>
      </div>
    </div>
  <!-- </div> -->

    <div class="ortalaAna">
      <div class="yazilar">
        <div class="yazi">
          <div class="ustr">
            <h2>SpiderMonkey Workflow Setup</h2>
            <div class="yazibilgisi">
              10 Aug 2019
            </div>

          </div>
          <hr>
          <div class="content">
            <div class="entry">
            <div class=".post-tag">
              
              <i class="fa fa-tags" float=right></i>
              
              <a href="/blog/tag/#notes"   class="post-tag">notes</a>
              
              <a href="/blog/tag/#setup"   class="post-tag">setup</a>
              
              <a href="/blog/tag/#spidermonkey"   class="post-tag">spidermonkey</a>
              
              
            </div>

            <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

            <!-- <div class="sidenav"> -->
            <!-- <div class="notice"> -->

            <nav class="toc">
            <header>
            <h2 class="nav__title">
            <i class="fas fa-file-alt"> Contents</i>
            </h2>
            </header>
            <!-- <div id="markdown-toc"> -->
            <ul>
  <li><a href="#code-review">Code Review</a></li>
  <li><a href="#debugging">Debugging</a></li>
</ul>

            <!-- </div> -->
            </nav>
            <!-- </div> -->
            <p>I wanted to take a few notes about my SpiderMonkey debugging and code review setup so that this can be a reference for the future me :). This short post will be about that only.</p>

<h1 id="code-review">Code Review</h1>

<p>My favorite editor is <a href="https://atom.io">Atom</a> and I use the <a href="https://github.com/MaskRay/ccls">ccls</a> language-server to go through the source code. Some atom packages I use -</p>
<ul>
  <li><a href="https://github.com/isundaylee/atom-ide-ccls">atom-ide-ccls</a>: language-client for <code class="highlighter-rouge">ccls</code></li>
  <li><a href="https://atom.io/packages/cursor-history">cursor-history</a>: To easily navigate back to the original position after looking up a (say) function definition.</li>
  <li><a href="https://atom.io/packages/hyperclick">hyperclick</a>: For jumping to definitions</li>
</ul>

<p>I use <a href="https://github.com/rizsotto/Bear">bear</a> to generate the compilation database for ccls. Thus doing a <code class="highlighter-rouge">bear make</code> while compiling the code generates the compilation database (in <code class="highlighter-rouge">compile_commands.json</code>)</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>js/src/
cp configure.in configure <span class="o">&amp;&amp;</span> autoconf2.13
mkdir build_debug.OBJ
<span class="nb">cd </span>build_debug.OBJ
../configure <span class="nt">--enable-debug</span> <span class="nt">--enable-optimize</span> <span class="nt">--enable-ion</span>
bear make <span class="nt">-j4</span>
<span class="nb">cd </span>dist/bin/
</code></pre></div></div>

<p>The generated compilation database should be placed in the root folder of the project, and the text editor should be started from this root folder. It takes some time (and a lot of CPU usage) for ccls to index the whole code, but once it’s done it makes code navigation a whole lot easier.</p>

<p>I usually have one debug (in <code class="highlighter-rouge">build_debug.OBJ</code>) and one non-debug build (in <code class="highlighter-rouge">build_nondebug.OBJ</code>). I use the non-debug build while building and testing the exploit as sometimes assertions in the debug build break the exploit. For the non-debug build just use <code class="highlighter-rouge">../configure --disable-debug --enable-optimize --enable-ion</code>.</p>

<h1 id="debugging">Debugging</h1>

<p>For debugging, I use gdb with <a href="https://github.com/hugsy/gef">gef</a>. Also, this <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Hacking_Tips">nice article</a> on MDN docs about SpiderMonkey debugging tips is pretty useful.</p>

<p>While trying to set a breakpoint in JIT compiled code, using the method method mentioned in the MDN page, I got the message saying that the <code class="highlighter-rouge">masm.breakpoint</code> has been ‘optimized out’. I guess it got inlined by gcc. So what I did was to place breakpoint on a function that was going to be inlined.</p>

<p>For eg,</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>

<span class="kd">function</span> <span class="nx">test</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nx">array</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
  <span class="kd">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{}</span>  <span class="c1">// JIT compile this function</span>
  <span class="k">return</span> <span class="nx">value</span><span class="o">+</span><span class="mh">0x1234</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">test</span><span class="p">()</span>
</code></pre></div></div>

<p>While JIT compiling this and generating the code for calling <code class="highlighter-rouge">Array.pop</code>, <code class="highlighter-rouge">js::jit::CodeGenerator::visitArrayPopShiftT</code> function is called.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>
<span class="n">CodeGenerator</span><span class="o">::</span><span class="n">visitArrayPopShiftT</span><span class="p">(</span><span class="n">LArrayPopShiftT</span><span class="o">*</span> <span class="n">lir</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Register</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ToRegister</span><span class="p">(</span><span class="n">lir</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">());</span>
    <span class="n">Register</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">ToRegister</span><span class="p">(</span><span class="n">lir</span><span class="o">-&gt;</span><span class="n">temp0</span><span class="p">());</span>
    <span class="n">Register</span> <span class="n">length</span> <span class="o">=</span> <span class="n">ToRegister</span><span class="p">(</span><span class="n">lir</span><span class="o">-&gt;</span><span class="n">temp1</span><span class="p">());</span>
    <span class="n">TypedOrValueRegister</span> <span class="n">out</span><span class="p">(</span><span class="n">lir</span><span class="o">-&gt;</span><span class="n">mir</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">(),</span> <span class="n">ToAnyRegister</span><span class="p">(</span><span class="n">lir</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">()));</span>
    <span class="n">emitArrayPopShift</span><span class="p">(</span><span class="n">lir</span><span class="p">,</span> <span class="n">lir</span><span class="o">-&gt;</span><span class="n">mir</span><span class="p">(),</span> <span class="n">obj</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is calling <code class="highlighter-rouge">emitArrayPopShift</code></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>
<span class="n">CodeGenerator</span><span class="o">::</span><span class="n">emitArrayPopShift</span><span class="p">(</span><span class="n">LInstruction</span><span class="o">*</span> <span class="n">lir</span><span class="p">,</span> <span class="k">const</span> <span class="n">MArrayPopShift</span><span class="o">*</span> <span class="n">mir</span><span class="p">,</span> <span class="n">Register</span> <span class="n">obj</span><span class="p">,</span>
                                 <span class="n">Register</span> <span class="n">elementsTemp</span><span class="p">,</span> <span class="n">Register</span> <span class="n">lengthTemp</span><span class="p">,</span> <span class="n">TypedOrValueRegister</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">OutOfLineCode</span><span class="o">*</span> <span class="n">ool</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mir</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">()</span> <span class="o">==</span> <span class="n">MArrayPopShift</span><span class="o">::</span><span class="n">Pop</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ool</span> <span class="o">=</span> <span class="n">oolCallVM</span><span class="p">(</span><span class="n">ArrayPopDenseInfo</span><span class="p">,</span> <span class="n">lir</span><span class="p">,</span> <span class="n">ArgList</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">StoreValueTo</span><span class="p">(</span><span class="n">out</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">MOZ_ASSERT</span><span class="p">(</span><span class="n">mir</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">()</span> <span class="o">==</span> <span class="n">MArrayPopShift</span><span class="o">::</span><span class="n">Shift</span><span class="p">);</span>
        <span class="n">ool</span> <span class="o">=</span> <span class="n">oolCallVM</span><span class="p">(</span><span class="n">ArrayShiftDenseInfo</span><span class="p">,</span> <span class="n">lir</span><span class="p">,</span> <span class="n">ArgList</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">StoreValueTo</span><span class="p">(</span><span class="n">out</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="o">:</span>
  <span class="o">:</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now this is basically emiting code that calls a VM function <code class="highlighter-rouge">js::jit::ArrayPopDense</code>. Thus we can set a breakpoint here. and then hit <code class="highlighter-rouge">fin</code> in gdb to continue execution till the end of this function. Here is a backtrace when this breakpoint is hit</p>

<p><img src="/assets/img/workflow/backtrace.png" alt="" /></p>

<p>The code at address <code class="highlighter-rouge">0x3ff959cc1f1c</code> is the one generated by Ion. Thus we just hit <code class="highlighter-rouge">fin</code> and the control stops when it starts executing the Ion code and we can now step through Ion code.</p>

<p>Thus for stepping through Ion generated code, I usually put a call to some function (like Array.pop, slice, push etc) that calls a VM function in the Ion code.</p>

<p>I’ll keep updating this post whenever I come across new stuff related to code review/debugging as these act as notes for the future :)</p>


            <!-- 
            <a href="/play-with-spidermonkey/" title="Playing around with SpiderMonkey" class="btn btn-info">&larr; Previous</a>
            
            
            <a href="/writeup/" title="Playing around with SpiderMonkey" class="btn btn-info" style="float: right;">Next &rarr;</a>
             -->
            <!-- [ previous](https://github.com/alperenbozkurt/JBlog){: .btn .btn-info} -->

            
            <div class="PageNavigation">
              
                
                  <a class="previous" href="/play-with-spidermonkey/">&laquo; Playing around with SpiderMonkey</a>
                
              
              
                
                  <a class="next" href="/writeup/">Write up for CVE-2019-11707 &raquo;</a>
                
              
            </div>
            
            <div style="clear:both"></div>
          </div>
         	</div>

        </div>
        <script src="http://localhost:4000/assets/js/jquery-1.12.2.min.js"></script>
<script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    $.goup({
        trigger: 500,
        bottomOffset: 10,
        locationOffset: 20,
        containerRadius: 0,
        containerColor: '#fff',
        arrowColor: '#000',
        goupSpeed: 'normal'
    });
});
</script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-123721864-1']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


        
  <div id="disqus_thread" class="yazi">  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://sherl0ck.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  <script id="dsq-count-scr" src="//sherl0ck.disqus.com/count.js" async></script>


      </div>
    </div>

        <div class="footer">
      <div class="ortalaAna">
        <div class="copy">
          sherl0ck's home © 2019
        </div>
        <div class="sosyal">
                        <div class="social-links">
                  <a href="mailto:vigneshsrao5@gmail.com" class="author-social" target="_blank"><i class="fa fa-2x fa-envelope-square"></i></a>
                  <a href="http://twitter.com/sherl0ck__" class="author-social" target="_blank"><i class="fa fa-2x fa-twitter-square"></i></a>
                  
                  
                  <a href="http://linkedin.com/in/vigneshsrao" class="author-social" target="_blank"><i class="fa fa-2x fa-linkedin-square"></i></a>
                  
                  
                  
                  <a href="http://github.com/vigneshsrao" class="author-social" target="_blank"><i class="fa fa-2x fa-github"></i></a>
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
            </div>

        </div>
      </div>
    </div>

  </body>
</html>

<!-- 
<i class="previous"><a href="/play-with-spidermonkey/" title="Playing around with SpiderMonkey">&larr; Previous</a></i>


<i class="next"><a href="/writeup/" title="Write up for CVE-2019-11707">Next &rarr;</a></i>
 -->
